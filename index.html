<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ржорзЗржЗржи ржЧрзЗржЗржЯ рж╕ржоржмрж╛ржпрж╝ рж╕ржорж┐рждрж┐</title>
  <!-- Added typography plugin for better notice rendering -->
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600&family=Noto+Sans+Bengali:wght@400;700&display=swap" rel="stylesheet">
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* ржлржирзНржЯ ржЖржкржбрзЗржЯ: 'Noto Sans Bengali' ржкрзНрж░ржзрж╛ржи ржлржирзНржЯ */
    body { font-family: 'Noto Sans Bengali', 'Hind Siliguri', sans-serif; }
    .spinner { border: 3px solid rgba(255,255,255,0.3); border-left-color: #ffffff; border-radius:50%; width:20px; height:20px; animation:spin 1s linear infinite;}
    .spinner-gray { border: 2px solid rgba(0,0,0,0.2); border-left-color: #4a5568; border-radius:50%; width:16px; height:16px; animation:spin 1s linear infinite;}
    @keyframes spin { 100% { transform: rotate(360deg);} }
    .modal-enter { opacity: 0; transform: scale(0.95); }
    .modal-enter-active { opacity: 1; transform: scale(1); transition: all 300ms ease-out; }
    .modal-exit { opacity: 1; transform: scale(1); }
    .modal-exit-active { opacity: 0; transform: scale(0.95); transition: all 300ms ease-in; }
    [type='date']::-webkit-calendar-picker-indicator {
        cursor: pointer;
        filter: invert(0.5) sepia(0.6) saturate(5) hue-rotate(200deg);
    }
    .tab-active {
        border-color: #4f46e5;
        color: #4f46e5;
        background-color: #eef2ff;
    }

    /* --- LOTTERY STYLES --- */
    #lottery-modal { font-family: 'Hind Siliguri', sans-serif; background-color: #0f172a; color: #f1f5f9; }
    #lottery-modal ::-webkit-scrollbar { width: 8px; }
    #lottery-modal ::-webkit-scrollbar-track { background: #1e293b; }
    #lottery-modal ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    .winner-highlight { animation: pulse 1s infinite; background: linear-gradient(45deg, #facc15, #fbbf24); color: #000 !important; transform: scale(1.05); box-shadow: 0 0 30px rgba(250, 204, 21, 0.6); border-color: #facc15 !important; }
    @keyframes pulse { 0%, 100% { transform: scale(1.02); } 50% { transform: scale(1.08); } }
    .lottery-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
    #confetti { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
    .active-highlight { background-color: #06b6d4; color: black; font-weight: bold; transform: scale(1.05); box-shadow: 0 0 15px rgba(6, 182, 212, 0.5); }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- Main Application Content (Hidden by default) -->
  <div id="main-app-content" class="hidden">
    
    <!-- Header -->
    <header class="w-full bg-gradient-to-r from-pink-600 to-red-600 text-white p-3 shadow-lg sticky top-0 z-40">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex flex-row justify-between items-center gap-4">
          <!-- Logo & Title -->
          <div class="flex items-center gap-3">
            <img id="header-logo-img" src="https://placehold.co/48x48/FFFFFF/F87171?text=рж▓рзЛржЧрзЛ" alt="рж▓рзЛржЧрзЛ" class="w-12 h-12 rounded-full border-2 border-white object-cover bg-white">
            <div class="flex-grow">
              <h1 class="text-2xl sm:text-3xl font-bold text-white py-0">
                ржорзЗржЗржи ржЧрзЗржЗржЯ рж╕ржоржмрж╛ржпрж╝ рж╕ржорж┐рждрж┐
              </h1>
              <p class="text-xs font-semibold text-pink-100"> рж╕рзНржерж╛ржкрж┐ржд: рзирзжрзирзл</p>
              <p class="text-sm font-bold text-white mt-1">тШЕ ржмрж┐рж╢рзНржмрж╛рж╕ тШЕ ржорж╛ржиржмрж┐ржХрждрж╛ тШЕ ржЙржирзНржиржпрж╝ржи тШЕ</p>
            </div>
          </div>
          
          <!-- Admin Panel Button -->
          <div>
            <button id="open-admin-btn" class="bg-white/10 hover:bg-white/20 text-white font-semibold py-2 px-4 rounded-lg backdrop-blur-sm transition flex items-center gap-2 border border-white/30 shadow-sm hover:shadow-md">
                <span class="text-xl">тЪЩя╕П</span> 
                <span class="hidden sm:inline">ржЕрзНржпрж╛ржбржорж┐ржи</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content Grid -->
    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 space-y-6">
      
      <!-- Content Column (Full Width Now) -->
      <div class="w-full space-y-6">
        
        <!-- Notice Board -->
        <div class="bg-white p-6 rounded-xl shadow-lg prose max-w-none">
          <div id="important-links-display" class="mb-4"></div>
          <div class="flex justify-end items-center mb-4 not-prose">
              <button id="edit-notice-btn" class="bg-gray-200 text-gray-700 py-1 px-3 rounded-lg font-semibold hover:bg-gray-300 transition text-sm">рж╕ржорзНржкрж╛ржжржирж╛</button>
          </div>
          <div id="notice-display" class="text-gray-700"></div>
          <div id="notice-edit" class="hidden space-y-3 not-prose">
              <textarea id="notice-textarea" rows="4" class="w-full p-2 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="ржирзЛржЯрж┐рж╢ рж▓рж┐ржЦрзБржи..."></textarea>
              <input id="notice-image-url" type="url" class="w-full p-2 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="ржЫржмрж┐рж░ рж▓рж┐ржВржХ (ржРржЪрзНржЫрж┐ржХ)">
              <input id="notice-link-text" type="text" class="w-full p-2 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="рж▓рж┐ржВржХрзЗрж░ ржирж╛ржо (ржпрзЗржоржи: 'ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд ржжрзЗржЦрзБржи')">
              <input id="notice-link-url" type="url" class="w-full p-2 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="рж╕ржорзНржкрзВрж░рзНржг рж▓рж┐ржВржХ (https://...)">

              <div class="pt-4 border-t mt-4">
                  <h5 class="text-md font-semibold text-gray-700 mb-2">ржирждрзБржи ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг рж▓рж┐ржВржХ ржпрзБржХрзНржд ржХрж░рзБржи</h5>
                  <div class="space-y-2">
                      <input id="new-link-name" type="text" class="w-full p-2 border rounded-lg" placeholder="рж▓рж┐ржВржХрзЗрж░ ржирж╛ржо (ржпрзЗржоржи: 'ржлрзЗрж╕ржмрзБржХ ржЧрзНрж░рзБржк')">
                      <input id="new-link-url" type="url" class="w-full p-2 border rounded-lg" placeholder="рж╕ржорзНржкрзВрж░рзНржг рж▓рж┐ржВржХ (https://...)">
                      <button id="save-new-link-btn" type="button" class="bg-blue-600 text-white py-2 px-3 rounded-lg font-bold hover:bg-blue-700 transition text-sm flex items-center gap-2">
                          <span>рж▓рж┐ржВржХ рж╕рзЗржн</span>
                          <div class="spinner hidden"></div>
                      </button>
                  </div>
              </div>

              <div class="flex gap-3 pt-4 border-t">
                  <button id="save-notice-btn" class="bg-green-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-green-700 transition flex items-center gap-2">
                      <span>ржирзЛржЯрж┐рж╢ рж╕рзЗржн</span>
                      <div class="spinner hidden"></div>
                  </button>
                  <button id="cancel-notice-btn" class="bg-gray-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-gray-600 transition">ржмрж╛рждрж┐рж▓</button>
              </div>
          </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="bg-white p-6 rounded-xl shadow-lg text-center transition-transform hover:scale-105">
            <h3 class="text-lg font-semibold text-gray-500 mb-2">ржорзЛржЯ рж╕ржжрж╕рзНржп</h3>
            <p id="total-members" class="text-4xl font-bold text-indigo-600">рзж</p>
          </div>
          <div class="bg-white p-6 rounded-xl shadow-lg text-center transition-transform hover:scale-105">
            <h3 class="text-lg font-semibold text-gray-500 mb-2">ржорзЛржЯ ржЬржорж╛</h3>
            <p id="total-paid" class="text-4xl font-bold text-green-600">рз│ рзж</p>
          </div>
          <div class="bg-white p-6 rounded-xl shadow-lg text-center transition-transform hover:scale-105">
            <h3 class="text-lg font-semibold text-gray-500 mb-2">ржорзЛржЯ ржЛржг ржкрзНрж░ржжрж╛ржи</h3>
            <p id="total-loan-given" class="text-4xl font-bold text-red-600">рз│ рзж</p>
          </div>
        </div>

        <!-- CHARTS SECTION (NEW) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Financial Overview Chart -->
            <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg flex flex-col">
                <h3 class="text-lg font-bold text-gray-700 mb-4 text-center border-b pb-2">ржЖрж░рзНржерж┐ржХ рж╕рж╛рж░рж╕ржВржХрзНрж╖рзЗржк</h3>
                <div class="flex-grow relative h-64 sm:h-80 w-full">
                    <canvas id="financeChart"></canvas>
                </div>
            </div>
            
            <!-- Monthly Trend Chart -->
            <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg flex flex-col">
                <h3 class="text-lg font-bold text-gray-700 mb-4 text-center border-b pb-2">ржорж╛рж╕рж┐ржХ ржЬржорж╛рж░ рж╣рж╛рж░</h3>
                <div class="flex-grow relative h-64 sm:h-80 w-full">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Monthly Lottery Banner -->
        <div class="bg-[#0f172a] p-6 rounded-xl shadow-xl flex flex-col sm:flex-row justify-between items-center gap-4 border border-slate-800 relative overflow-hidden group">
            <div class="absolute top-0 right-0 w-64 h-64 bg-blue-600/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
            <div class="flex items-center gap-4 z-10">
                <div class="bg-slate-800 p-3 rounded-xl shadow-inner border border-slate-700">
                    <span class="text-3xl">ЁЯО▓</span>
                </div>
                <div>
                    <h3 class="text-2xl font-bold text-cyan-400">ржорж╛рж╕рж┐ржХ рж▓ржЯрж╛рж░рж┐</h3>
                    <p class="text-slate-400 text-sm font-medium">ржнрж╛ржЧрзНржп ржкрж░рзАржХрзНрж╖рж╛ ржУ ржлрж▓рж╛ржлрж▓</p>
                </div>
            </div>
            <div class="z-10 w-full sm:w-auto">
                <button id="main-lottery-btn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-xl shadow-lg shadow-blue-600/30 transition transform hover:scale-105 active:scale-95 flex justify-center items-center gap-2">
                    рж▓ржЯрж╛рж░рж┐ ржбрзНрж░ ржХрж░рзБржи
                </button>
            </div>
        </div>

        <!-- Add Member Form -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
          <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-3">ржирждрзБржи рж╕ржжрж╕рзНржп ржпрзЛржЧ ржХрж░рзБржи</h3>
          <form id="add-member-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input id="member-name" type="text" placeholder="рж╕ржжрж╕рзНржпрзЗрж░ ржирж╛ржо (ржЖржмрж╢рзНржпржХ)" class="p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
            <input id="member-phone" type="text" placeholder="ржлрзЛржи ржиржорзНржмрж░ (ржЖржмрж╢рзНржпржХ)" class="p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
            <input id="member-photo-url" type="url" placeholder="ржЫржмрж┐рж░ рж▓рж┐ржВржХ (ржРржЪрзНржЫрж┐ржХ)" class="p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <input id="member-employee-id" type="text" placeholder="ржПржоржкрзНрж▓ржпрж╝рж┐ ржЖржЗржбрж┐ (ржРржЪрзНржЫрж┐ржХ)" class="p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <input id="member-card-number" type="text" placeholder="ржХрж╛рж░рзНржб ржиржорзНржмрж░ (ржРржЪрзНржЫрж┐ржХ)" class="p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <input id="member-email" type="email" placeholder="ржЗржорзЗржЗрж▓ (ржРржЪрзНржЫрж┐ржХ)" class="p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <button type="submit" class="md:col-span-2 w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition duration-200 shadow-md disabled:opacity-50 flex justify-center items-center gap-2">
              <span>рж╕ржжрж╕рзНржп ржпрзЛржЧ ржХрж░рзБржи</span>
              <div class="spinner hidden"></div>
            </button>
          </form>
        </div>

        <!-- Member List -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
          <div class="p-4 sm:p-6 flex flex-col sm:flex-row justify-between sm:items-center gap-4 border-b">
            <h3 class="text-2xl font-bold text-gray-800">рж╕ржжрж╕рзНржп рждрж╛рж▓рж┐ржХрж╛</h3>
            <div class="space-x-2">
                <button id="open-fund-modal-btn" class="bg-blue-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-blue-700 transition duration-200 shadow-sm">ржорж╛рж╕рж┐ржХ рждрж╣ржмрж┐рж▓</button>
            </div>
          </div>
          <div class="p-4 border-b">
              <!-- Updated Search Placeholder -->
              <input id="search-member-input" type="search" placeholder="рж╕ржжрж╕рзНржп ржЦрзБржБржЬрзБржи (ржирж╛ржо, ржорзЛржмрж╛ржЗрж▓, ржЖржЗржбрж┐, ржХрж╛рж░рзНржб...)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" autocomplete="off">
          </div>
          <div id="member-list-cards" class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
          <div id="member-list-placeholder" class="hidden p-6 text-center text-gray-500"></div>
        </div>
      </div> 
    </main>

    <!-- Sync Status -->
    <div id="sync-status" class="fixed bottom-4 right-4 bg-gray-800 text-white py-2 px-4 rounded-lg shadow-xl transition-opacity duration-300 opacity-0 z-50">
      <div class="flex items-center gap-2">
          <div id="sync-spinner" class="spinner-gray hidden"></div>
          <span id="sync-text">рж╕рж┐ржЩрзНржХ рж╣ржЪрзНржЫрзЗ...</span>
      </div>
    </div>
    
    <!-- Message Box -->
    <div id="message-box" class="fixed top-5 left-1/2 -translate-x-1/2 z-[300] transition-opacity duration-300 opacity-0">
        <div id="message-content"></div>
    </div>
  </div>
  
  <!-- Verify Email Modal -->
  <div id="verify-email-modal" class="hidden fixed inset-0 bg-gray-100 z-[150] justify-center items-center p-4">
    <div class="bg-white w-full max-w-md p-8 rounded-xl shadow-2xl text-center">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">ржЖржкржирж╛рж░ ржЗржорзЗржЗрж▓ ржнрзЗрж░рж┐ржлрж╛ржЗ ржХрж░рзБржи</h2>
      <p class="text-gray-600 mb-6">ржЖржорж░рж╛ ржЖржкржирж╛рж░ <strong id="user-email-info" class="text-indigo-600">...</strong> ржарж┐ржХрж╛ржирж╛рзЯ ржПржХржЯрж┐ ржнрзЗрж░рж┐ржлрж┐ржХрзЗрж╢ржи рж▓рж┐ржЩрзНржХ ржкрж╛ржарж┐рзЯрзЗржЫрж┐ред</p>
      <div class="flex flex-col sm:flex-row gap-4">
        <button id="resend-verification-btn" class="flex-1 bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition duration-200">рж▓рж┐ржЩрзНржХржЯрж┐ ржЖржмрж╛рж░ ржкрж╛ржарж╛ржи</button>
        <button id="logout-btn" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-400 transition duration-200">рж▓ржЧ ржЖржЙржЯ</button>
      </div>
    </div>
  </div>

  <!-- Auth Modal -->
  <div id="auth-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 z-[200] justify-center items-center p-4 transition-opacity duration-300">
      <div class="bg-white w-full max-w-sm p-6 sm:p-8 rounded-xl shadow-2xl transition-transform duration-300 transform scale-95">
          <div class="flex border-b mb-6">
              <button id="login-tab" class="flex-1 py-2 text-center font-semibold border-b-2 tab-active">ржкрзНрж░ржмрзЗрж╢ ржХрж░рзБржи</button>
              <button id="register-tab" class="flex-1 py-2 text-center font-semibold border-b-2 border-transparent text-gray-500">ржирж┐ржмржирзНржзржи ржХрж░рзБржи</button>
          </div>
          <div id="login-view">
            <form id="login-form" class="space-y-4">
              <div><label class="block text-sm font-medium text-gray-700 mb-1">ржЗржорзЗржЗрж▓</label><input type="email" id="login-email" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></div>
              <div><label class="block text-sm font-medium text-gray-700 mb-1">ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб</label><input type="password" id="login-password" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></div>
              <p id="login-error" class="text-red-500 text-sm h-4"></p>
              <button id="login-button" type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition duration-200 shadow-md disabled:opacity-50 flex justify-center items-center gap-2"><span>ржкрзНрж░ржмрзЗрж╢ ржХрж░рзБржи</span><div class="spinner hidden"></div></button>
            </form>
          </div>
          <div id="register-view" class="hidden">
            <form id="register-form" class="space-y-4">
              <div><label class="block text-sm font-medium text-gray-700 mb-1">ржЗржорзЗржЗрж▓</label><input type="email" id="register-email" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></div>
              <div><label class="block text-sm font-medium text-gray-700 mb-1">ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб (ржХржоржкржХрзНрж╖рзЗ рзм ржЕржХрзНрж╖рж░)</label><input type="password" id="register-password" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></div>
              <div><label class="block text-sm font-medium text-gray-700 mb-1">ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзБржи</label><input type="password" id="confirm-password" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></div>
              <p id="register-error" class="text-red-500 text-sm h-4"></p>
              <button id="register-button" type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition duration-200 shadow-md disabled:opacity-50 flex justify-center items-center gap-2"><span>ржирж┐ржмржирзНржзржи ржХрж░рзБржи</span><div class="spinner hidden"></div></button>
            </form>
          </div>
      </div>
  </div>

  <!-- Admin Modal (Fix: Ensure it can close) -->
  <div id="admin-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-[60] justify-center items-center p-4">
    <div id="admin-modal-box" class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 relative modal-exit">
      <button id="close-admin-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl font-bold cursor-pointer">&times;</button>
      <h3 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4">ржЕрзНржпрж╛ржбржорж┐ржи ржкрзНржпрж╛ржирзЗрж▓</h3>
      
      <!-- Logo Edit -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-1">рж▓рзЛржЧрзЛ рж╕ржорзНржкрж╛ржжржирж╛</label>
        <input id="logo-url-input" type="url" placeholder="рж▓рзЛржЧрзЛ рж▓рж┐ржВржХ ржПржЦрж╛ржирзЗ ржжрж┐ржи" class="w-full p-2 rounded-lg text-gray-800 text-sm border border-gray-300 focus:ring-2 focus:ring-pink-300 focus:outline-none">
        <button id="save-logo-btn" class="mt-2 w-full bg-white text-pink-600 py-2 px-4 rounded-lg font-bold hover:bg-pink-100 transition duration-200 text-sm flex-shrink-0 flex justify-center items-center gap-2 border border-pink-300">
          <span>рж▓рзЛржЧрзЛ рж╕рзЗржн</span>
          <div class="spinner-gray hidden"></div>
        </button>
      </div>
      
      <!-- Lottery Button -->
      <div class="mb-6">
         <button id="open-lottery-btn" class="w-full bg-gradient-to-r from-cyan-500 to-blue-600 text-white py-3 px-4 rounded-xl font-bold hover:scale-105 transition shadow-md flex justify-center items-center gap-2"><span>ЁЯО▓ рж▓рж╛ржХрж┐ рж▓ржЯрж╛рж░рж┐</span></button>
      </div>

      <!-- Change Password Section -->
      <div class="mb-6 pt-4 border-t">
          <label class="block text-sm font-medium text-gray-700 mb-1">ржЕрзНржпрж╛ржбржорж┐ржи ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб ржкрж░рж┐ржмрж░рзНрждржи</label>
          <input id="new-admin-password" type="password" placeholder="ржирждрзБржи ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб (ржХржоржкржХрзНрж╖рзЗ рзм ржЕржХрзНрж╖рж░)" class="w-full p-2 rounded-lg text-gray-800 text-sm border border-gray-300 focus:ring-2 focus:ring-indigo-300 focus:outline-none">
          <button id="save-password-btn" class="mt-2 w-full bg-indigo-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-indigo-700 transition duration-200 text-sm flex justify-center items-center gap-2">
            <span>ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб ржЖржкржбрзЗржЯ</span>
            <div class="spinner hidden"></div>
          </button>
      </div>

      <!-- Logout -->
      <div class="pt-4 border-t">
        <button id="logout-main-btn" class="w-full bg-red-700 text-white py-2 px-4 rounded-lg font-bold hover:bg-red-800 transition duration-200 text-sm">
          рж▓ржЧ ржЖржЙржЯ
        </button>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profile-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 justify-center items-center p-4">
    <div id="profile-modal-box" class="bg-white rounded-xl shadow-2xl w-full max-w-7xl p-6 relative h-[90vh] flex flex-col">
      <button id="close-profile" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl font-bold" title="ржмржирзНржз ржХрж░рзБржи">&times;</button>
      <div id="profile-modal-content" class="flex flex-col h-full">
        <div class="flex flex-col items-center justify-center pt-2 pb-6 border-b">
            <img id="profile-header-img" src="https://placehold.co/96x96/EFEFEF/AAAAAA?text=?" alt="рж╕ржжрж╕рзНржпрзЗрж░ ржЫржмрж┐" class="w-24 h-24 rounded-full object-cover border-4 border-indigo-200 shadow-lg mb-3">
            <h2 id="profile-header-name" class="text-3xl font-bold text-indigo-700 truncate">рж╕ржжрж╕рзНржпрзЗрж░ ржирж╛ржо</h2>
        </div>
        <div class="flex border-b border-gray-200 mb-6 flex-shrink-0">
            <button id="profile-tab-details" class="profile-tab tab-active flex items-center justify-center gap-2 py-3 px-6 font-semibold"><span class="hidden sm:inline">ЁЯСд</span><span>рж╕ржжрж╕рзНржп ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд</span></button>
            <button id="profile-tab-transactions" class="profile-tab text-gray-500 flex items-center justify-center gap-2 py-3 px-6 font-semibold"><span class="hidden sm:inline">ЁЯз╛</span><span>рж▓рзЗржиржжрзЗржи</span></button>
            <button id="profile-tab-summary" class="profile-tab text-gray-500 flex items-center justify-center gap-2 py-3 px-6 font-semibold"><span class="hidden sm:inline">ЁЯУИ</span><span>рж╕рж╛рж░-рж╕ржВржХрзНрж╖рзЗржк</span></button>
        </div>
        <div id="profile-content-container" class="overflow-y-auto flex-grow">
            <!-- Details Panel -->
            <div id="profile-content-details">
                <div class="flex justify-end space-x-2 mb-4">
                    <button id="edit-profile-btn" class="bg-yellow-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-yellow-600 transition flex items-center gap-2"><span>рж╕ржорзНржкрж╛ржжржирж╛</span><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button>
                    <button id="save-profile-btn" class="hidden bg-green-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-green-600 transition flex items-center gap-2"><span>рж╕рзЗржн</span><div id="save-profile-spinner" class="spinner hidden"></div></button>
                    <button id="cancel-edit-btn" class="hidden bg-gray-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-gray-600 transition">ржмрж╛рждрж┐рж▓</button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-4 text-sm">
                    <p class="text-gray-600 flex flex-col sm:col-span-2"><span class="font-semibold text-gray-800 mb-1">ржирж╛ржо:</span><span id="profile-name-view" class="text-gray-900 bg-gray-100 p-2 rounded"></span><input id="profile-name-edit" type="text" class="hidden border rounded-lg p-2"></p>
                    <p class="text-gray-600 flex flex-col sm:col-span-2"><span class="font-semibold text-gray-800 mb-1">ржЗржЙржЬрж╛рж░ ржЖржЗржбрж┐:</span> <span id="profile-id" class="text-xs text-indigo-500 bg-gray-100 p-2 rounded select-all"></span></p>
                    <p class="text-gray-600 flex flex-col"><span class="font-semibold text-gray-800 mb-1">ржЫржмрж┐рж░ рж▓рж┐ржВржХ:</span><span id="profile-photo-url-view" class="text-gray-900 bg-gray-100 p-2 rounded break-all"></span><input id="profile-photo-url-edit" type="url" class="hidden border rounded-lg p-2"></p>
                    <p class="text-gray-600 flex flex-col"><span class="font-semibold text-gray-800 mb-1">ржПржоржкрзНрж▓ржпрж╝рж┐ ржЖржЗржбрж┐:</span><span id="profile-employee-id-view" class="text-gray-900 bg-gray-100 p-2 rounded"></span><input id="profile-employee-id-edit" type="text" class="hidden border rounded-lg p-2"></p>
                    <p class="text-gray-600 flex flex-col"><span class="font-semibold text-gray-800 mb-1">ржХрж╛рж░рзНржб ржиржорзНржмрж░:</span><span id="profile-card-number-view" class="text-gray-900 bg-gray-100 p-2 rounded"></span><input id="profile-card-number-edit" type="text" class="hidden border rounded-lg p-2"></p>
                    <p class="text-gray-600 flex flex-col"><span class="font-semibold text-gray-800 mb-1">ржЗржорзЗржЗрж▓:</span><span id="profile-email-view" class="text-gray-900 bg-gray-100 p-2 rounded break-all"></span><input id="profile-email-edit" type="email" class="hidden border rounded-lg p-2"></p>
                    <p class="text-gray-600 flex flex-col"><span class="font-semibold text-gray-800 mb-1">ржлрзЛржи:</span><span id="profile-phone-view" class="text-gray-900 bg-gray-100 p-2 rounded"></span><input id="profile-phone-edit" type="text" class="hidden border rounded-lg p-2"></p>
                    <p class="text-gray-600 flex flex-col sm:col-span-2"><span class="font-semibold text-gray-800 mb-1">ржирзЛржЯ:</span><span id="profile-notes-view" class="text-gray-900 bg-gray-100 p-2 rounded min-h-[50px] whitespace-pre-wrap"></span><textarea id="profile-notes-edit" rows="3" class="hidden border rounded-lg p-2"></textarea></p>
                </div>
                <div class="mt-8 pt-6 border-t text-center"><button id="delete-member-btn" class="bg-red-600 text-white py-2 px-6 rounded-lg font-bold hover:bg-red-700 transition duration-200 shadow-md">ЁЯЧСя╕П рж╕ржжрж╕рзНржп ржбрж┐рж▓рзЗржЯ ржХрж░рзБржи</button></div>
            </div>
            <!-- Transactions Panel -->
            <div id="profile-content-transactions" class="hidden h-full">
                <div class="flex justify-end mb-4 gap-2"><button id="open-transaction-modal-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-indigo-700 transition flex items-center gap-2"><span>ржирждрзБржи рж▓рзЗржиржжрзЗржи</span><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg></button></div>
                <div class="overflow-y-auto border rounded-lg shadow-inner h-full">
                    <table class="min-w-full bg-gray-50">
                        <thead class="bg-indigo-100 sticky top-0"><tr><th class="py-2 px-4 text-left text-xs font-medium text-gray-600 uppercase">рждрж╛рж░рж┐ржЦ</th><th class="py-2 px-4 text-left text-xs font-medium text-gray-600 uppercase">ржмрж┐ржмрж░ржг</th><th class="py-2 px-4 text-right text-xs font-medium text-gray-600 uppercase">ржкрж░рж┐ржорж╛ржг (рз│)</th><th class="py-2 px-4 text-center text-xs font-medium text-gray-600 uppercase">ржЕрзНржпрж╛ржХрж╢ржи</th></tr></thead>
                        <tbody id="transactions-table-body" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
            <!-- Summary Panel -->
            <div id="profile-content-summary" class="hidden">
                 <h3 class="text-2xl font-semibold text-green-600 border-b pb-2 pt-4 mb-6">ЁЯУИ рж╕рж╛рж░рж╕ржВржХрзНрж╖рзЗржк</h3>
                <div class="grid grid-cols-2 gap-4 text-center py-4">
                    <div><p class="text-sm text-gray-500">ржорзЛржЯ ржЬржорж╛</p><p id="paid-total" class="text-2xl font-bold text-green-600">рз│ рзж</p></div>
                    <div><p class="text-sm text-gray-500">ржорзЛржЯ ржЛржг ржЧрзНрж░рж╣ржг</p><p id="loan-taken" class="text-2xl font-bold text-blue-600">рз│ рзж</p></div>
                    <div><p class="text-sm text-gray-500">ржорзЛржЯ ржЛржг ржкрж░рж┐рж╢рзЛржз</p><p id="loan-repaid" class="text-2xl font-bold text-yellow-600">рз│ рзж</p></div>
                    <div><p class="text-sm text-gray-500">ржмрж░рзНрждржорж╛ржи ржЛржг</p><p id="current-loan" class="text-2xl font-bold text-red-600">рз│ рзж</p></div>
                </div>
            </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Transaction Modal -->
  <div id="transaction-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 z-[60] flex justify-center items-center p-4">
    <div id="transaction-modal-box" class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 relative modal-exit m-auto">
        <button id="close-transaction-modal" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 text-3xl font-bold transition">&times;</button>
        <h3 id="transaction-modal-title" class="text-2xl font-bold mb-6 text-center text-indigo-600 border-b pb-2">ржХрж┐рж╕рзНрждрж┐/рж▓рзЗржиржжрзЗржи ржПржирзНржЯрзНрж░рж┐</h3>
        <form id="transaction-form" class="space-y-5">
            <input type="hidden" id="transaction-id" name="id">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1 text-center">рждрж╛рж░рж┐ржЦ</label>
                <input type="date" id="transaction-date" name="date" required class="w-full p-3 border border-gray-300 rounded-xl text-center bg-gray-50 focus:ring-2 focus:ring-indigo-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1 text-center">рж▓рзЗржиржжрзЗржирзЗрж░ ржзрж░ржи</label>
                <select id="transaction-type" name="type" required class="w-full p-3 border border-gray-300 rounded-xl bg-white text-center focus:ring-2 focus:ring-indigo-500 outline-none font-semibold">
                    <option value="deposit">ржХрж┐рж╕рзНрждрж┐/ржЬржорж╛</option>
                    <option value="loanTaken">ржЛржг ржЧрзНрж░рж╣ржг</option>
                    <option value="loanRepayment">ржЛржг ржкрж░рж┐рж╢рзЛржз</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1 text-center">ржкрж░рж┐ржорж╛ржг (рз│)</label>
                <input type="number" id="transaction-amount" name="amount" placeholder="рзж.рзжрзж" required class="w-full p-4 border-2 border-indigo-100 rounded-xl text-center text-2xl font-bold text-indigo-700 focus:border-indigo-500 outline-none shadow-inner">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1 text-center">ржоржирзНрждржмрзНржп (ржРржЪрзНржЫрж┐ржХ)</label>
                <textarea id="transaction-description" name="description" rows="2" class="w-full p-3 border border-gray-300 rounded-xl text-center focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="ржоржирзНрждржмрзНржп рж▓рж┐ржЦрзБржи..."></textarea>
            </div>
            <button type="submit" class="w-full bg-gradient-to-r from-indigo-600 to-blue-600 text-white py-4 rounded-xl font-bold text-lg hover:shadow-lg hover:scale-[1.02] transition flex justify-center items-center gap-2">
                <span id="transaction-btn-text">рж╕рзЗржн ржХрж░рзБржи</span>
                <div id="transaction-spinner" class="spinner hidden"></div>
            </button>
        </form>
    </div>
  </div>

  <!-- Fund Modal -->
  <div id="fund-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 justify-center items-start p-4 pt-16">
      <div id="fund-modal-box" class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 relative modal-exit">
          <button id="close-fund-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl font-bold" title="ржмржирзНржз ржХрж░рзБржи">&times;</button>
          <h3 class="text-2xl font-bold mb-6 text-center text-blue-600">ржорж╛рж╕рж┐ржХ рждрж╣ржмрж┐рж▓ ржмрзНржпржмрж╕рзНржерж╛ржкржирж╛</h3>
          <div id="fund-list-container" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2"></div>
      </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-[70] justify-center items-center p-4">
        <div id="confirmation-modal-box" class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 text-center modal-exit">
            <p id="confirmation-message" class="text-lg mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-yes" class="bg-red-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-red-700">рж╣рзНржпрж╛ржБ</button>
                <button id="confirm-no" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-lg font-bold hover:bg-gray-400">ржирж╛</button>
            </div>
        </div>
  </div>

  <!-- Lottery Modal -->
  <div id="lottery-modal" class="hidden fixed inset-0 z-[100] flex flex-col bg-[#0f172a]">
    <canvas id="confetti"></canvas>
    <div class="absolute top-4 left-4 z-50"><button id="close-lottery-btn" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-lg border border-slate-500"><span>тмЕ ржлрж┐рж░рзЗ ржпрж╛ржи</span></button></div>
    <div class="w-full max-w-[1800px] mx-auto p-4 lg:p-8 grid grid-cols-1 lg:grid-cols-12 gap-6 lg:gap-8 grow mt-12 overflow-y-auto">
        <!-- Left Sidebar -->
        <div class="lg:col-span-4 flex flex-col gap-6">
            <div class="text-center"><h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600 mb-2">ржорзЗржЗржи ржЧрзЗржЗржЯ рж╕ржоржмрж╛ржпрж╝ рж╕ржорж┐рждрж┐ ржорж╛рж╕рж┐ржХ рж▓ржЯрж╛рж░рж┐</h1><p class="text-slate-400">ржнрж╛ржЧрзНржп ржкрж░рзАржХрзНрж╖рж╛ ржХрж░рж╛рж░ рж╕рзЗрж░рж╛ ржорж╛ржзрзНржпржо</p></div>
            
            <!-- Input Form Centered -->
            <div class="lottery-card p-6 rounded-xl shadow-lg text-center">
                <form id="lotteryAddForm" class="flex flex-col gap-4 items-center">
                    <label class="text-lg text-slate-300 font-semibold">ржирждрзБржи ржЕржВрж╢ржЧрзНрж░рж╣ржгржХрж╛рж░рзА ржпрзЛржЧ ржХрж░рзБржи</label>
                    <div class="flex gap-2 w-full max-w-md">
                        <input id="lotteryNameInput" type="text" placeholder="ржирж╛ржо рж▓рж┐ржЦрзБржи..." class="flex-1 bg-slate-800 border border-slate-600 text-white px-4 py-3 rounded-lg focus:outline-none focus:border-cyan-500 text-center transition-all focus:scale-105">
                        <button type="submit" class="bg-cyan-600 hover:bg-cyan-500 text-white px-6 py-3 rounded-lg font-semibold shadow-lg hover:shadow-cyan-500/50 transition-all">ржпрзЛржЧ</button>
                    </div>
                </form>
            </div>

            <div class="flex gap-3"><button id="lotteryDrawBtn" class="flex-1 bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-500 hover:to-blue-500 text-white py-4 rounded-xl font-bold text-xl shadow-lg transition transform hover:scale-105 active:scale-95">ржбрзНрж░ рж╢рзБрж░рзБ ржХрж░рзБржи ЁЯО▓</button><button id="lotteryClearListBtn" class="px-5 py-4 bg-slate-700 hover:bg-red-500/20 hover:text-red-400 text-slate-300 rounded-xl border border-slate-600 transition" title="рж╕ржм ржирж╛ржо ржорзБржЫрзБржи">ЁЯЧСя╕П</button></div>
            <div class="lottery-card p-4 rounded-xl flex-1 min-h-[200px]"><div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2"><h2 class="text-lg font-semibold text-slate-300">ЁЯУЬ ржкрзВрж░рзНржмржмрж░рзНрждрзА ржЗрждрж┐рж╣рж╛рж╕</h2><button id="lotteryClearHistoryBtn" class="text-xs text-red-400 hover:text-red-300">ржЗрждрж┐рж╣рж╛рж╕ ржорзБржЫрзБржи</button></div><ul id="lotteryHistory" class="space-y-2 max-h-[300px] overflow-y-auto pr-2 text-sm"></ul></div>
        </div>
        <!-- Right/Main Display -->
        <div class="lg:col-span-8 flex flex-col gap-6 h-full">
            <div id="lotteryWinnerSection" class="hidden w-full transition-all duration-500"><div class="lottery-card p-10 rounded-3xl border-4 border-yellow-500/50 shadow-[0_0_80px_rgba(234,179,8,0.5)] text-center bg-gradient-to-b from-slate-800/90 to-slate-900/95 backdrop-blur-xl transform scale-105"><h3 class="text-3xl text-yellow-400 mb-6 font-bold animate-pulse">ЁЯОЙ ржЕржнрж┐ржиржирзНржжржи! ржЖржЬржХрзЗрж░ ржмрж┐ржЬрзЯрзА ЁЯОЙ</h3><div id="lotteryWinnerText" class="text-6xl md:text-8xl font-extrabold text-white break-words drop-shadow-[0_5px_5px_rgba(0,0,0,0.8)] tracking-wide"></div></div></div>
            <div class="lottery-card p-6 rounded-xl flex-1 flex flex-col shadow-xl h-full min-h-[400px]"><div class="flex justify-between items-center mb-4 px-2"><h2 class="text-2xl font-semibold text-slate-200">ржЕржВрж╢ржЧрзНрж░рж╣ржгржХрж╛рж░рзА <span class="text-base font-normal text-slate-400 ml-2">(ржорзЛржЯ: <span id="lotteryCountBadge" class="text-cyan-400 font-bold">0</span>)</span></h2></div><ul id="lotteryParticipants" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3 overflow-y-auto pr-2 flex-1 content-start"><li class="col-span-full text-center text-slate-500 italic py-10 text-lg">ржХрзЛржирзЛ ржирж╛ржо ржпрзЛржЧ ржХрж░рж╛ рж╣рзЯржирж┐</li></ul></div>
        </div>
    </div>
    <footer class="w-full py-6 text-center border-t border-slate-800/50 mt-auto bg-[#0f172a]/50 backdrop-blur-sm"><p class="text-slate-500 text-sm font-mono">All rights reserved ┬й Sahadot 2025</p></footer>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, createUserWithEmailAndPassword, sendEmailVerification, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    setLogLevel('Debug');
    
    // --- FIREBASE CONFIGURATION (Reverted to your specific project config) ---
    const appId = 'default-samiti-app-id';
    const firebaseConfig = { apiKey: "AIzaSyBdfxO5LL9KfzJe-PhvaRbhDhz9G-QH1aE", authDomain: "sg-loan-online.firebaseapp.com", projectId: "sg-loan-online", storageBucket: "sg-loan-online.firebasestorage.app", messagingSenderId: "933667418231", appId: "1:933667418231:web:11c24150426bf869381672" };

    let app, db, auth;
    let members = [], fundDistribution = {}, notice = { text: '', imageUrl: '', linkText: '', linkUrl: '' }, logoUrl = '', importantLinks = [], lottery = { participants: [], history: [], liveDraw: null };
    let activeMember = null, isSaving = false, verificationCheckInterval = null, searchQuery = '';
    
    // NEW STATE FOR FUND EDITING
    let editingFundMonth = null;
    
    // CHARTS
    let financeChartInstance = null;
    let trendChartInstance = null;
    
    // Live Lottery Sync Variables
    let lastDrawTime = 0; 
    let iAmTheDrawer = false;
    let isFirstSnapshot = true;

    // --- UTILS ---
    const getBengaliNumber = (n) => { if (n == null || isNaN(n)) return "рзж"; return new Intl.NumberFormat('bn-BD', { minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(n); };
    const formatDate = (d, f='long') => { if (!d) return ''; const dt = new Date(d); if(f==='monthYear') return dt.toLocaleString('bn-BD', {month:'long', year:'numeric'}); return `${new Intl.NumberFormat('bn-BD').format(dt.getDate())} ${dt.toLocaleString('bn-BD', {month:'long'})}, ${new Intl.NumberFormat('bn-BD').format(dt.getFullYear())}`; };
    const showMessage = (m, t='success') => { const b = document.getElementById('message-box'), c = document.getElementById('message-content'); c.className = `shadow-xl rounded-lg p-4 font-semibold text-white ${t==='error'?'bg-red-500':t==='info'?'bg-blue-500':'bg-green-500'} flex items-center space-x-2`; c.innerHTML = `<span>${m}</span>`; b.classList.remove('opacity-0'); setTimeout(() => b.classList.add('opacity-0'), 4000); };
    const showConfirmation = (msg) => new Promise(res => { document.getElementById('confirmation-message').textContent = msg; const box = document.getElementById('confirmation-modal-box'), m = document.getElementById('confirmation-modal'); const y = document.getElementById('confirm-yes'), n = document.getElementById('confirm-no'); const cl = (v) => { box.classList.remove('modal-enter-active'); box.classList.add('modal-exit-active'); setTimeout(() => { m.classList.add('hidden'); res(v); }, 300); }; const hy = () => { cleanup(); cl(true); }, hn = () => { cleanup(); cl(false); }, cleanup = () => { y.removeEventListener('click', hy); n.removeEventListener('click', hn); }; y.addEventListener('click', hy); n.addEventListener('click', hn); m.classList.remove('hidden'); m.classList.add('flex', 'modal-enter', 'modal-enter-active'); });
    const showSyncStatus = (t, s=false) => { document.getElementById('sync-text').textContent = t; document.getElementById('sync-status').classList.remove('opacity-0'); document.getElementById('sync-spinner').classList.toggle('hidden', !s); };
    const hideSyncStatus = () => setTimeout(() => document.getElementById('sync-status').classList.add('opacity-0'), 1500);
    const calculateMemberTotals = (m) => { const t = { totalDeposit: 0, totalLoanTaken: 0, totalLoanRepaid: 0, currentLoan: 0 }; (m?.transactions || []).forEach(tx => { const a = Number(tx.amount)||0; if(tx.type==='deposit') t.totalDeposit+=a; else if(tx.type==='loanTaken') t.totalLoanTaken+=a; else if(tx.type==='loanRepayment') t.totalLoanRepaid+=a; }); t.currentLoan = t.totalLoanTaken - t.totalLoanRepaid; return t; };
    const calculateAvailableFund = () => { let td=0, tlt=0, tlr=0; members.forEach(m => { const t = calculateMemberTotals(m); td+=t.totalDeposit; tlt+=t.totalLoanTaken; tlr+=t.totalLoanRepaid; }); return td + tlr - tlt; };

    // --- CHART RENDERING ---
    const renderCharts = (td, tlt, tlr) => {
        // 1. Finance Overview Bar Chart
        const ctxFinance = document.getElementById('financeChart').getContext('2d');
        if (financeChartInstance) financeChartInstance.destroy();
        
        financeChartInstance = new Chart(ctxFinance, {
            type: 'bar',
            data: {
                labels: ['ржорзЛржЯ ржЬржорж╛', 'ржЛржг ржкрзНрж░ржжрж╛ржи', 'ржЛржг ржлрзЗрж░ржд'],
                datasets: [{
                    label: 'ржкрж░рж┐ржорж╛ржг (ржЯрж╛ржХрж╛)',
                    data: [td, tlt, tlr],
                    backgroundColor: [
                        'rgba(22, 163, 74, 0.7)', // Green for Deposit
                        'rgba(220, 38, 38, 0.7)', // Red for Loan Given
                        'rgba(202, 138, 4, 0.7)'  // Yellow/Gold for Loan Repaid
                    ],
                    borderColor: [
                        'rgb(22, 163, 74)',
                        'rgb(220, 38, 38)',
                        'rgb(202, 138, 4)'
                    ],
                    borderWidth: 1,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: { label: (c) => `рз│ ${getBengaliNumber(c.raw)}` }
                    }
                },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#f3f4f6' } },
                    x: { grid: { display: false } }
                }
            }
        });

        // 2. Monthly Trend Line Chart
        const monthlyData = {};
        members.forEach(m => {
            (m.transactions || []).forEach(t => {
                if (t.type === 'deposit') {
                    const month = t.date.substring(0, 7); // YYYY-MM
                    monthlyData[month] = (monthlyData[month] || 0) + Number(t.amount);
                }
            });
        });
        
        const sortedMonths = Object.keys(monthlyData).sort();
        // Optionally slice to show last 12 months if it gets too long
        const displayMonths = sortedMonths; // .slice(-12); 

        const labels = displayMonths.map(m => {
            const d = new Date(m + '-01');
            return d.toLocaleString('bn-BD', { month: 'short', year: 'numeric' });
        });
        const data = displayMonths.map(m => monthlyData[m]);

        const ctxTrend = document.getElementById('trendChart').getContext('2d');
        if (trendChartInstance) trendChartInstance.destroy();

        trendChartInstance = new Chart(ctxTrend, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'ржорж╛рж╕рж┐ржХ ржЬржорж╛',
                    data: data,
                    borderColor: 'rgb(79, 70, 229)', // Indigo
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgb(79, 70, 229)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: { label: (c) => `рз│ ${getBengaliNumber(c.raw)}` }
                    }
                },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#f3f4f6' } },
                    x: { grid: { display: false } }
                }
            }
        });
    };

    // --- UI RENDERING ---
    const renderHeaderLogo = () => { const img = document.getElementById('header-logo-img'); img.src = logoUrl || 'https://placehold.co/48x48/FFFFFF/F87171?text=рж▓рзЛржЧрзЛ'; img.onerror = () => img.src = 'https://placehold.co/48x48/FFFFFF/F87171?text=рж▓рзЛржЧрзЛ'; document.getElementById('logo-url-input').value = logoUrl || ''; };
    const renderImportantLinks = () => {
        const c = document.getElementById('important-links-display'); if (importantLinks.length === 0) { c.innerHTML = ''; return; }
        c.innerHTML = `<h4 class="text-lg font-semibold text-gray-800 mb-2 not-prose">ЁЯФЧ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг рж▓рж┐ржВржХрж╕ржорзВрж╣</h4><div class="flex flex-wrap gap-2 not-prose">${importantLinks.map(l => `<a href="${l.url}" target="_blank" class="bg-indigo-100 text-indigo-700 text-sm font-medium px-3 py-1 rounded-full hover:bg-indigo-200 transition duration-200 flex items-center gap-2"><span>${l.name}</span><button class="delete-link-btn text-indigo-400 hover:text-indigo-600 font-bold" data-id="${l.id}">&times;</button></a>`).join('')}</div><hr class="my-4">`;
    };
    const renderNoticeBoard = () => {
        const d = document.getElementById('notice-display'); d.innerHTML = '';
        if (!notice.text && !notice.imageUrl && !notice.linkUrl) { d.innerHTML = '<p class="text-gray-500">ржЖржкрж╛рждржд ржХрзЛржирзЛ ржирждрзБржи ржирзЛржЯрж┐рж╢ ржирзЗржЗред</p>'; return; }
        if (notice.imageUrl) d.innerHTML += `<img src="${notice.imageUrl}" class="max-w-full h-auto rounded-lg mb-4 mx-auto" onerror="this.style.display='none'">`;
        if (notice.text) d.innerHTML += `<div>${notice.text.split('\n').map(l => `<p>${l}</p>`).join('')}</div>`;
        if (notice.linkUrl) d.innerHTML += `<a href="${notice.linkUrl}" target="_blank" class="inline-block bg-indigo-600 text-white font-bold py-2 px-5 rounded-lg mt-4 no-underline">${notice.linkText||'ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд'}</a>`;
    };
    const renderUI = () => {
        let td = 0, tlt = 0, tlr = 0; 
        members.forEach(m => { 
            const t = calculateMemberTotals(m); 
            td += t.totalDeposit; 
            tlt += t.totalLoanTaken; 
            tlr += t.totalLoanRepaid; 
        });
        
        document.getElementById('total-members').textContent = getBengaliNumber(members.length);
        document.getElementById('total-paid').textContent = `рз│ ${getBengaliNumber(td)}`;
        document.getElementById('total-loan-given').textContent = `рз│ ${getBengaliNumber(tlt)}`;
        
        // RENDER CHARTS
        renderCharts(td, tlt, tlr);

        const c = document.getElementById('member-list-cards'), p = document.getElementById('member-list-placeholder'); c.innerHTML = '';
        
        // --- UPDATED SEARCH LOGIC ---
        const fm = members.filter(m => { 
            const q = searchQuery.toLowerCase(); 
            return (m.name||'').toLowerCase().includes(q) || 
                   (m.id||'').toLowerCase().includes(q) || 
                   (m.cardNumber||'').toLowerCase().includes(q) ||
                   (m.phone||'').includes(q) ||
                   (m.employeeId||'').toLowerCase().includes(q);
        });
        
        if (fm.length === 0) { p.classList.remove('hidden'); p.textContent = searchQuery ? 'ржХрзЛржирзЛ рж╕ржжрж╕рзНржп ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐ред' : 'ржХрзЛржирзЛ рж╕ржжрж╕рзНржп ржирзЗржЗред'; }
        else {
            p.classList.add('hidden');
            fm.sort((a,b)=>a.name.localeCompare(b.name, 'bn')).forEach(m => {
                const t = calculateMemberTotals(m);
                c.innerHTML += `<div class="bg-white rounded-lg shadow-md border border-gray-200 p-4 flex flex-col transition-transform hover:scale-[1.02] duration-200">
                    <div class="flex items-center gap-4 mb-4"><img class="h-16 w-16 rounded-full object-cover border-2 border-indigo-200" src="${m.photoUrl||`https://placehold.co/64x64/EFEFEF/AAAAAA?text=${m.name[0]}`}" onerror="this.src='https://placehold.co/64x64/EFEFEF/AAAAAA?text=?'"><div class="overflow-hidden"><h4 class="text-lg font-bold text-gray-900 truncate">${m.name}</h4><p class="text-sm text-gray-600">ржХрж╛рж░рзНржб: ${m.cardNumber||'N/A'}</p><p class="text-sm text-gray-600">ржлрзЛржи: ${m.phone}</p></div></div>
                    <div class="space-y-2 flex-grow"><div class="flex justify-between bg-green-50 p-2 rounded-md"><span class="text-sm font-medium text-green-700">ржорзЛржЯ ржЬржорж╛:</span><span class="text-lg font-bold text-green-600">рз│ ${getBengaliNumber(t.totalDeposit)}</span></div><div class="flex justify-between bg-red-50 p-2 rounded-md"><span class="text-sm font-medium text-red-700">ржмрж░рзНрждржорж╛ржи ржЛржг:</span><span class="text-lg font-bold text-red-600">рз│ ${getBengaliNumber(t.currentLoan)}</span></div></div>
                    <button class="view-profile-btn mt-4 w-full bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-bold hover:bg-indigo-600" data-id="${m.id}">ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд ржжрзЗржЦрзБржи</button></div>`;
            });
        }
        if (activeMember && !fm.find(m => m.id === activeMember.id)) closeProfileModal();
        else if (activeMember) showProfile(activeMember.id, false);
    };
    
    const toggleProfileEditMode = (isEditing) => {
        document.querySelectorAll('#profile-content-details [id$="-view"]').forEach(el => el.classList.toggle('hidden', isEditing));
        document.querySelectorAll('#profile-content-details [id$="-edit"]').forEach(el => el.classList.toggle('hidden', !isEditing));
        document.getElementById('edit-profile-btn').classList.toggle('hidden', isEditing);
        document.getElementById('save-profile-btn').classList.toggle('hidden', !isEditing);
        document.getElementById('cancel-edit-btn').classList.toggle('hidden', !isEditing);
    };

    const showProfile = (id, anim=true) => {
        const m = members.find(x => x.id === id); activeMember = m; if (!m) return;
        toggleProfileEditMode(false);
        const t = calculateMemberTotals(m);
        document.getElementById('profile-header-img').src = m.photoUrl || `https://placehold.co/96x96/EFEFEF/AAAAAA?text=${m.name[0]}`;
        document.getElementById('profile-header-name').textContent = m.name;
        ['name','id','photo-url','employee-id','card-number','email','phone','notes'].forEach(k => {
            const v = document.getElementById(`profile-${k}-view`); const e = document.getElementById(`profile-${k}-edit`);
            const val = m[k.replace(/-/g,'')] || m[k==='photo-url'?'photoUrl':k==='employee-id'?'employeeId':k==='card-number'?'cardNumber':k] || 'N/A';
            if(v) v.textContent = val; if(e) e.value = val === 'N/A' ? '' : val;
        });
        document.getElementById('paid-total').textContent = `рз│ ${getBengaliNumber(t.totalDeposit)}`;
        document.getElementById('loan-taken').textContent = `рз│ ${getBengaliNumber(t.totalLoanTaken)}`;
        document.getElementById('loan-repaid').textContent = `рз│ ${getBengaliNumber(t.totalLoanRepaid)}`;
        document.getElementById('current-loan').textContent = `рз│ ${getBengaliNumber(t.currentLoan)}`;
        
        document.getElementById('transactions-table-body').innerHTML = (m.transactions||[]).length===0 ? '<tr><td colspan="4" class="py-4 text-center text-gray-500">ржХрзЛржирзЛ рж▓рзЗржиржжрзЗржи ржирзЗржЗред</td></tr>' :
            [...m.transactions].sort((a,b)=>new Date(b.date)-new Date(a.date)).map(tx => {
                const clr = tx.type==='deposit'?'text-green-600':tx.type==='loanTaken'?'text-blue-600':'text-yellow-700';
                const typ = tx.type==='deposit'?'ржХрж┐рж╕рзНрждрж┐/ржЬржорж╛':tx.type==='loanTaken'?'ржЛржг ржЧрзНрж░рж╣ржг':'ржЛржг ржкрж░рж┐рж╢рзЛржз';
                return `<tr class="hover:bg-gray-100"><td class="py-2 px-4 text-sm">${formatDate(tx.date)}</td><td class="py-2 px-4 text-sm">${typ}${tx.linkedDepositId?' ЁЯФЧ':''}<br><span class="text-xs text-gray-500">${tx.description||''}</span></td><td class="py-2 px-4 text-right font-mono font-semibold ${clr}">${getBengaliNumber(tx.amount)}</td><td class="py-2 px-4 text-center space-x-2"><button class="edit-transaction-btn text-blue-500" data-tid="${tx.id}" ${tx.linkedDepositId?'disabled':''}>тЬПя╕П</button><button class="delete-transaction-btn text-red-500" data-tid="${tx.id}" ${tx.linkedDepositId?'disabled':''}>ЁЯЧСя╕П</button></td></tr>`;
            }).join('');

        document.getElementById('profile-modal').classList.remove('hidden', 'flex');
        document.getElementById('profile-modal').classList.add('flex');
        if (anim) { document.getElementById('profile-modal-box').classList.add('modal-enter-active'); }
    };
    const closeProfileModal = () => { document.getElementById('profile-modal').classList.add('hidden'); activeMember = null; };
    
    const openTransactionModal = (tid=null) => {
        document.getElementById('transaction-form').reset();
        document.getElementById('transaction-id').value = tid || '';
        document.getElementById('transaction-date').valueAsDate = new Date();
        document.getElementById('transaction-type').disabled = !!tid;
        document.getElementById('transaction-modal-title').textContent = tid ? "рж▓рзЗржиржжрзЗржи рж╕ржорзНржкрж╛ржжржирж╛" : "ржирждрзБржи рж▓рзЗржиржжрзЗржи";
        if(tid) {
            const tx = activeMember.transactions.find(t=>t.id===tid);
            if(tx) {
                const f = document.getElementById('transaction-form');
                f.id.value=tx.id; f.date.value=tx.date; f.type.value=tx.type; f.amount.value=tx.amount; f.description.value=tx.description||'';
            }
        }
        document.getElementById('transaction-modal').classList.remove('hidden');
        document.getElementById('transaction-modal').classList.add('flex');
    };
    const closeTransactionModal = () => document.getElementById('transaction-modal').classList.add('hidden');

    const renderFundModal = () => {
        const c = document.getElementById('fund-list-container');
        const md = {}; members.forEach(m => (m.transactions||[]).forEach(t => { if(t.type==='deposit') { const k = t.date.substring(0,7); md[k]=(md[k]||0)+Number(t.amount); } }));
        const g = calculateAvailableFund();
        const keys = Object.keys(md).sort().reverse();
        
        if (keys.length === 0) {
            c.innerHTML = '<div class="text-center text-gray-500">ржХрзЛржирзЛ ржбрзЗржЯрж╛ ржирзЗржЗред</div>';
            return;
        }

        c.innerHTML = keys.map(k => {
            const dist = fundDistribution[k]; 
            const r = dist ? members.find(m=>m.id===dist.receiverId) : null;
            const max = Math.min(g, md[k]);
            const isEditing = editingFundMonth === k;

            let content = '';
            
            if (isEditing && dist) {
                // EDIT MODE
                content = `
                    <div class="mt-3 p-3 border border-blue-200 rounded-lg bg-blue-50">
                        <h5 class="text-sm font-bold text-blue-800 mb-2">рждрж╣ржмрж┐рж▓ рждржерзНржп рж╕ржорзНржкрж╛ржжржирж╛ ржХрж░рзБржи</h5>
                        <form class="edit-fund-form space-y-3" data-month="${k}">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">ржкрзНрж░рж╛ржкржХ</label>
                                <select name="receiverId" required class="w-full p-2 border rounded-lg bg-white text-sm">
                                    ${members.map(m => `<option value="${m.id}" ${m.id === dist.receiverId ? 'selected' : ''}>${m.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">ржкрж░рж┐ржорж╛ржг (рз│)</label>
                                <input type="number" name="amount" required class="w-full p-2 border rounded-lg text-sm" min="0" value="${dist.amount}">
                            </div>
                            <div class="flex gap-2 pt-1">
                                <button type="submit" class="bg-green-600 text-white px-3 py-1.5 rounded text-sm hover:bg-green-700">рж╕рзЗржн ржХрж░рзБржи</button>
                                <button type="button" class="cancel-fund-edit bg-gray-400 text-white px-3 py-1.5 rounded text-sm hover:bg-gray-500">ржмрж╛рждрж┐рж▓</button>
                            </div>
                        </form>
                    </div>
                `;
            } else if (r) {
                // DISPLAY MODE WITH EDIT BUTTON
                content = `
                    <div class="mt-3 p-3 bg-green-50 rounded-lg flex items-center justify-between gap-2 group">
                        <div class="flex items-center gap-4">
                            <img src="${r.photoUrl||`https://placehold.co/40x40?text=${r.name[0]}`}" class="w-12 h-12 rounded-full border-2 border-green-200 object-cover">
                            <div>
                                <p class="text-sm font-semibold text-green-700">тЬЕ рждрж╣ржмрж┐рж▓ ржкрзНрж░рж╛ржкрзНржд:</p>
                                <p class="text-lg font-bold">${r.name}</p>
                                <p class="text-md font-semibold text-green-600">рз│ ${getBengaliNumber(dist.amount)}</p>
                            </div>
                        </div>
                        <button class="edit-fund-btn bg-white border border-gray-200 p-2 rounded-full shadow-sm hover:bg-gray-100 text-blue-600 transition opacity-0 group-hover:opacity-100 focus:opacity-100" data-month="${k}" title="рж╕ржорзНржкрж╛ржжржирж╛ ржХрж░рзБржи">
                            тЬПя╕П
                        </button>
                    </div>
                `;
            } else {
                // ASSIGN MODE
                content = `
                    <form class="assign-fund-form mt-3 space-y-2" data-month="${k}">
                        <p class="text-xs">рж╕рж░рзНржмрзЛржЪрзНржЪ ржЛржгржпрзЛржЧрзНржп: <b>рз│ ${getBengaliNumber(max)}</b></p>
                        <p class="text-xs text-gray-500">(рждрж╣ржмрж┐рж▓рзЗ ржЕржмрж╢рж┐рж╖рзНржЯ: рз│ ${getBengaliNumber(g)})</p>
                        <select required class="w-full p-2 border rounded-lg bg-white">
                            <option value="">рж╕ржжрж╕рзНржп ржирж┐рж░рзНржмрж╛ржЪржи</option>
                            ${members.map(m=>`<option value="${m.id}">${m.name}</option>`).join('')}
                        </select>
                        <input type="number" required class="w-full p-2 border rounded-lg" min="0" max="${max}" data-max="${max}">
                        <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">ржЛржг ржкрзНрж░ржжрж╛ржи ржХрж░рзБржи</button>
                    </form>
                `;
            }

            return `<div class="p-4 border rounded-lg shadow-sm bg-white">
                <h4 class="text-lg font-semibold text-blue-700">${formatDate(k+'-01','monthYear')}</h4>
                <p class="text-sm">ржорзЛржЯ ржЬржорж╛: <b>рз│ ${getBengaliNumber(md[k])}</b></p>
                ${content}
            </div>`;
        }).join('');
    };

    // --- FIREBASE OPS ---
    const initFirebase = () => { 
        try { 
            app = initializeApp(firebaseConfig); 
            db = getFirestore(app); 
            auth = getAuth(app); 

            // Initialize Auth State Listener HERE
            onAuthStateChanged(auth, u => {
                if (u && u.emailVerified) { document.getElementById('auth-modal').classList.add('hidden'); document.getElementById('verify-email-modal').classList.add('hidden'); document.getElementById('main-app-content').classList.remove('hidden'); listen(); }
                else if (u) { document.getElementById('user-email-info').textContent = u.email; document.getElementById('verify-email-modal').classList.remove('hidden'); document.getElementById('verify-email-modal').classList.add('flex'); document.getElementById('main-app-content').classList.add('hidden'); }
                else { document.getElementById('auth-modal').classList.remove('hidden'); document.getElementById('auth-modal').classList.add('flex'); document.getElementById('main-app-content').classList.add('hidden'); }
            });

        } catch(e) { 
            console.error(e);
            showMessage('ржбрж╛ржЯрж╛ржмрзЗрж╕ рж╕ржВржпрзЛржЧ ржмрж╛ ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи рждрзНрж░рзБржЯрж┐: ' + e.message, 'error'); 
        } 
    };
    
    const updateData = async (d) => { 
        if (isSaving) return; isSaving = true; showSyncStatus("рж╕рж┐ржЩрзНржХ...", true); 
        try { 
            await setDoc(doc(db, 'artifacts', appId, 'public-data', 'main'), { 
                members: d.members!==undefined?d.members:members, 
                fundDistribution: d.fundDistribution!==undefined?d.fundDistribution:fundDistribution, 
                notice: d.notice!==undefined?d.notice:notice, 
                logoUrl: d.logoUrl!==undefined?d.logoUrl:logoUrl, 
                importantLinks: d.importantLinks!==undefined?d.importantLinks:importantLinks,
                lottery: d.lottery!==undefined?d.lottery:lottery 
            }); 
            showSyncStatus("рж╕рзЗржн рж╣рзЯрзЗржЫрзЗ"); 
        } catch(e){ showMessage("рж╕рзЗржн ржмрзНржпрж░рзНрже", 'error'); } finally { isSaving=false; hideSyncStatus(); } 
    };

    const listen = () => onSnapshot(doc(db, 'artifacts', appId, 'public-data', 'main'), s => {
        const d = s.data(); if(!d) return;
        members = d.members || []; fundDistribution = d.fundDistribution || {}; logoUrl = d.logoUrl || ''; importantLinks = d.importantLinks || [];
        notice = typeof d.notice === 'string' ? {text: d.notice} : (d.notice || {});
        
        // Lottery Sync
        const dbLottery = d.lottery || { participants: [], history: [], liveDraw: null };
        lottery.participants = dbLottery.participants || [];
        lottery.history = dbLottery.history || [];
        
        // LIVE DRAW SYNC LOGIC
        if (dbLottery.liveDraw) {
            if (isFirstSnapshot) {
                // On first load, don't trigger animation for old draws, just sync state
                lastDrawTime = dbLottery.liveDraw.ts;
            } else if (dbLottery.liveDraw.ts > lastDrawTime) {
                // New draw detected!
                lastDrawTime = dbLottery.liveDraw.ts;
                if (!l_isAnimating) {
                   // Ensure modal is open if user is somewhere else? 
                   // Option: Auto-open modal or show notification. For now, we animate if modal is open.
                   // If modal is closed, user misses animation but sees result later.
                   if (!document.getElementById('lottery-modal').classList.contains('hidden')) {
                       startLiveLottery(dbLottery.liveDraw.winnerIndex);
                   }
                }
            }
        }
        isFirstSnapshot = false;

        renderUI(); renderNoticeBoard(); renderHeaderLogo(); renderImportantLinks(); 
        if(!document.getElementById('fund-modal').classList.contains('hidden')) renderFundModal();
        if(!document.getElementById('lottery-modal').classList.contains('hidden') && !l_isAnimating) renderLottery();
    });

    // Initialize the app
    initFirebase();
    
    // --- EVENT LISTENERS ---
    document.getElementById('login-form').addEventListener('submit', async e => { e.preventDefault(); try { await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value); } catch(e){ document.getElementById('login-error').textContent='ржнрзБрж▓ рждржерзНржпред'; } });
    document.getElementById('register-form').addEventListener('submit', async e => { e.preventDefault(); const p = document.getElementById('register-password').value; if(p!==document.getElementById('confirm-password').value) return document.getElementById('register-error').textContent='ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб ржорж┐рж▓ржЫрзЗ ржирж╛'; try { const c = await createUserWithEmailAndPassword(auth, document.getElementById('register-email').value, p); await sendEmailVerification(c.user); showMessage('ржнрзЗрж░рж┐ржлрж┐ржХрзЗрж╢ржи рж▓рж┐ржЩрзНржХ ржкрж╛ржарж╛ржирзЛ рж╣рзЯрзЗржЫрзЗред'); } catch(e){ document.getElementById('register-error').textContent='ржирж┐ржмржирзНржзржи ржмрзНржпрж░рзНржеред'; } });
    document.getElementById('logout-main-btn').addEventListener('click', () => signOut(auth));
    document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
    document.getElementById('resend-verification-btn').addEventListener('click', async () => { if(auth.currentUser) await sendEmailVerification(auth.currentUser); showMessage('ржкрж╛ржарж╛ржирзЛ рж╣рзЯрзЗржЫрзЗред'); });
    
    document.getElementById('add-member-form').addEventListener('submit', async e => { e.preventDefault(); const n = document.getElementById('member-name').value, p = document.getElementById('member-phone').value; if(!n||!p) return showMessage('ржирж╛ржо ржУ ржлрзЛржи ржЖржмрж╢рзНржпржХ', 'error'); await updateData({ members: [...members, { id: 'M'+Date.now(), name: n, phone: p, transactions: [], photoUrl: document.getElementById('member-photo-url').value, employeeId: document.getElementById('member-employee-id').value, cardNumber: document.getElementById('member-card-number').value, email: document.getElementById('member-email').value, notes: '' }] }); e.target.reset(); showMessage('рж╕ржжрж╕рзНржп ржпрзЛржЧ рж╣рзЯрзЗржЫрзЗ'); });
    document.getElementById('search-member-input').addEventListener('input', (e) => { searchQuery = e.target.value; renderUI(); });

    // ADMIN PASSWORD CHANGE LISTENER
    document.getElementById('save-password-btn').addEventListener('click', async () => {
        const newPass = document.getElementById('new-admin-password').value;
        if (!newPass || newPass.length < 6) return showMessage('ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб ржЕржирзНрждржд рзм ржЕржХрзНрж╖рж░рзЗрж░ рж╣рждрзЗ рж╣ржмрзЗ', 'error');
        
        const btn = document.getElementById('save-password-btn');
        const spin = btn.querySelector('.spinner');
        const txt = btn.querySelector('span');
        
        txt.textContent = 'ржЖржкржбрзЗржЯ рж╣ржЪрзНржЫрзЗ...';
        spin.classList.remove('hidden');
        btn.disabled = true;

        try {
            const user = auth.currentUser;
            if (user) {
                await updatePassword(user, newPass);
                showMessage('ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб рж╕ржлрж▓ржнрж╛ржмрзЗ ржкрж░рж┐ржмрж░рзНрждржи рж╣рзЯрзЗржЫрзЗред ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ ржЖржмрж╛рж░ рж▓ржЧржЗржи ржХрж░рзБржиред');
                document.getElementById('new-admin-password').value = '';
                setTimeout(() => signOut(auth), 2000); // Auto logout for security
            } else {
                showMessage('ржмрзНржпржмрж╣рж╛рж░ржХрж╛рж░рзА рж▓ржЧржЗржи ржЕржмрж╕рзНржерж╛рзЯ ржирзЗржЗ', 'error');
            }
        } catch (error) {
            console.error(error);
            if (error.code === 'auth/requires-recent-login') {
                showMessage('рж╕рзБрж░ржХрзНрж╖рж╛рж░ ржЬржирзНржп ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ рж▓ржЧржЖржЙржЯ ржХрж░рзЗ ржЖржмрж╛рж░ рж▓ржЧржЗржи ржХрж░рзБржи, рждрж╛рж░ржкрж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рзБржиред', 'error');
            } else {
                showMessage('ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб ржкрж░рж┐ржмрж░рзНрждржи ржмрзНржпрж░рзНрже: ' + error.message, 'error');
            }
        } finally {
            txt.textContent = 'ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб ржЖржкржбрзЗржЯ';
            spin.classList.add('hidden');
            btn.disabled = false;
        }
    });

    document.addEventListener('click', async e => {
        const t = e.target.closest('button, svg'); if (!t) return;
        
        // Profile Tabs
        if (t.classList.contains('profile-tab')) {
            document.querySelectorAll('.profile-tab').forEach(x=>x.classList.remove('tab-active', 'text-indigo-600')); t.classList.add('tab-active', 'text-indigo-600');
            document.getElementById('profile-content-details').classList.toggle('hidden', t.id!=='profile-tab-details');
            document.getElementById('profile-content-transactions').classList.toggle('hidden', t.id!=='profile-tab-transactions');
            document.getElementById('profile-content-summary').classList.toggle('hidden', t.id!=='profile-tab-summary');
        }

        if (t.id==='login-tab' || t.id==='register-tab') { document.getElementById('login-tab').classList.toggle('tab-active'); document.getElementById('register-tab').classList.toggle('tab-active'); document.getElementById('login-view').classList.toggle('hidden'); document.getElementById('register-view').classList.toggle('hidden'); }
        if (t.id==='save-logo-btn') await updateData({ logoUrl: document.getElementById('logo-url-input').value });
        if (t.id==='save-new-link-btn') { const n = document.getElementById('new-link-name').value, u = document.getElementById('new-link-url').value; if(n&&u) { await updateData({ importantLinks: [...importantLinks, {id:'L'+Date.now(), name:n, url:u}] }); document.getElementById('new-link-name').value=''; document.getElementById('new-link-url').value=''; showMessage('рж▓рж┐ржВржХ рж╕рзЗржн рж╣рзЯрзЗржЫрзЗ'); } }
        if (t.classList.contains('delete-link-btn')) { if(await showConfirmation('рж▓рж┐ржВржХ ржорзБржЫржмрзЗржи?')) await updateData({ importantLinks: importantLinks.filter(l => l.id !== t.dataset.id) }); }
        
        if (t.classList.contains('view-profile-btn')) showProfile(t.dataset.id);
        if (t.id==='close-profile') closeProfileModal();
        if (t.id==='edit-profile-btn') toggleProfileEditMode(true);
        if (t.id==='cancel-edit-btn') { showProfile(activeMember.id, false); toggleProfileEditMode(false); }
        
        if (t.id==='save-profile-btn') { const u = { name: document.getElementById('profile-name-edit').value, phone: document.getElementById('profile-phone-edit').value, photoUrl: document.getElementById('profile-photo-url-edit').value, employeeId: document.getElementById('profile-employee-id-edit').value, cardNumber: document.getElementById('profile-card-number-edit').value, email: document.getElementById('profile-email-edit').value, notes: document.getElementById('profile-notes-edit').value }; const mm = JSON.parse(JSON.stringify(members)); Object.assign(mm.find(m=>m.id===activeMember.id), u); await updateData({ members: mm }); showMessage('ржЖржкржбрзЗржЯ рж╣рзЯрзЗржЫрзЗ'); activeMember = mm.find(m=>m.id===activeMember.id); showProfile(activeMember.id, false); }
        if (t.id==='delete-member-btn') { if(await showConfirmation('рж╕ржжрж╕рзНржп ржорзБржЫржмрзЗржи?')) { await updateData({ members: members.filter(m=>m.id!==activeMember.id) }); closeProfileModal(); showMessage('ржорзБржЫрзЗ ржлрзЗрж▓рж╛ рж╣рзЯрзЗржЫрзЗ'); } }
        
        if (t.id==='open-transaction-modal-btn') openTransactionModal();
        if (t.id==='close-transaction-modal') closeTransactionModal();
        if (t.classList.contains('edit-transaction-btn')) openTransactionModal(t.dataset.tid);
        if (t.classList.contains('delete-transaction-btn')) { 
             if(await showConfirmation('рж▓рзЗржиржжрзЗржи ржорзБржЫржмрзЗржи?')) { 
                const mm = JSON.parse(JSON.stringify(members)); const m = mm.find(x=>x.id===activeMember.id); 
                m.transactions = m.transactions.filter(x => x.id !== t.dataset.tid && x.linkedDepositId !== t.dataset.tid); 
                await updateData({ members: mm }); showMessage('рж▓рзЗржиржжрзЗржи ржорзБржЫрзЗ ржлрзЗрж▓рж╛ рж╣рзЯрзЗржЫрзЗ'); showProfile(m.id, false); 
            } 
        }

        if (t.id==='open-fund-modal-btn') { editingFundMonth = null; renderFundModal(); document.getElementById('fund-modal').classList.remove('hidden'); document.getElementById('fund-modal').classList.add('flex'); }
        if (t.id==='close-fund-modal') document.getElementById('fund-modal').classList.add('hidden');
        
        if (t.classList.contains('edit-fund-btn')) { editingFundMonth = t.dataset.month; renderFundModal(); }
        if (t.classList.contains('cancel-fund-edit')) { editingFundMonth = null; renderFundModal(); }

        if (t.id==='edit-notice-btn') { document.getElementById('notice-display').classList.add('hidden'); t.classList.add('hidden'); document.getElementById('notice-edit').classList.remove('hidden'); document.getElementById('notice-textarea').value=notice.text||''; document.getElementById('notice-image-url').value=notice.imageUrl||''; document.getElementById('notice-link-text').value=notice.linkText||''; document.getElementById('notice-link-url').value=notice.linkUrl||''; document.getElementById('new-link-name').value=''; document.getElementById('new-link-url').value=''; }
        if (t.id==='cancel-notice-btn') { document.getElementById('notice-edit').classList.add('hidden'); document.getElementById('notice-display').classList.remove('hidden'); document.getElementById('edit-notice-btn').classList.remove('hidden'); }
        if (t.id==='save-notice-btn') { await updateData({ notice: { text: document.getElementById('notice-textarea').value, imageUrl: document.getElementById('notice-image-url').value, linkText: document.getElementById('notice-link-text').value, linkUrl: document.getElementById('notice-link-url').value } }); document.getElementById('notice-edit').classList.add('hidden'); document.getElementById('notice-display').classList.remove('hidden'); document.getElementById('edit-notice-btn').classList.remove('hidden'); showMessage('ржирзЛржЯрж┐рж╢ ржЖржкржбрзЗржЯ рж╣рзЯрзЗржЫрзЗ'); }
        
        // Admin & Lottery Triggers
        if (t.id === 'open-admin-btn' || t.closest('#open-admin-btn')) { document.getElementById('admin-modal').classList.remove('hidden'); document.getElementById('admin-modal').classList.add('flex'); }
        
        // FIXED ADMIN CLOSE LOGIC
        if (t.id === 'close-admin-modal' || t.closest('#close-admin-modal')) { 
            document.getElementById('admin-modal').classList.add('hidden'); 
            document.getElementById('admin-modal').classList.remove('flex'); 
        }

        if (t.id === 'open-lottery-btn' || t.closest('#open-lottery-btn')) { document.getElementById('admin-modal').classList.add('hidden'); document.getElementById('lottery-modal').classList.remove('hidden'); initLottery(); }
        // NEW LISTENER FOR MAIN PAGE LOTTERY BUTTON
        if (t.id === 'main-lottery-btn' || t.closest('#main-lottery-btn')) { document.getElementById('lottery-modal').classList.remove('hidden'); initLottery(); }

        if (t.id === 'close-lottery-btn' || t.closest('#close-lottery-btn')) { document.getElementById('lottery-modal').classList.add('hidden'); }
        if (t.id === 'lotteryClearListBtn') clearLotteryList();
        if (t.id === 'lotteryClearHistoryBtn') clearLotteryHistory();
    });

    document.getElementById('transaction-form').addEventListener('submit', async e => { 
        e.preventDefault(); const f = e.target; const amt = Number(f.amount.value); if(amt<0) return; 
        const mm = JSON.parse(JSON.stringify(members)); const m = mm.find(x=>x.id===activeMember.id); 
        const d = { date: f.date.value, type: f.type.value, amount: amt, description: f.description.value };
        if(f.id.value) { 
            const idx = m.transactions.findIndex(x=>x.id===f.id.value); 
            const oldTx = m.transactions[idx]; m.transactions[idx] = { ...oldTx, ...d };
            if(d.type==='deposit') {
                const linkedIdx = m.transactions.findIndex(t=>t.linkedDepositId===f.id.value);
                const cur = calculateMemberTotals({ transactions: m.transactions.filter(t=>t.id!==f.id.value && t.linkedDepositId!==f.id.value) }).currentLoan;
                const rep = Math.min(amt, cur);
                if(linkedIdx>-1) { if(rep>0) { m.transactions[linkedIdx].amount=rep; m.transactions[linkedIdx].date=d.date; } else m.transactions.splice(linkedIdx,1); }
                else if(rep>0) m.transactions.push({ id:'T'+(Date.now()+1), date:d.date, type:'loanRepayment', amount:rep, description:'ржХрж┐рж╕рзНрждрж┐ ржерзЗржХрзЗ рж╕рзНржмржпрж╝ржВржХрзНрж░рж┐ржпрж╝ ржкрж░рж┐рж╢рзЛржз', linkedDepositId:f.id.value });
            }
        } 
        else { 
            const nid = 'T'+Date.now(); m.transactions.push({ id: nid, ...d }); 
            if(d.type==='deposit') { const cur = calculateMemberTotals(m).currentLoan; if(cur>0) m.transactions.push({ id: 'T'+(Date.now()+1), date: d.date, type: 'loanRepayment', amount: Math.min(amt, cur), description: 'ржХрж┐рж╕рзНрждрж┐ ржерзЗржХрзЗ рж╕рзНржмржпрж╝ржВржХрзНрж░рж┐ржпрж╝ ржкрж░рж┐рж╢рзЛржз', linkedDepositId: nid }); } 
        }
        await updateData({ members: mm }); closeTransactionModal(); showProfile(m.id, false); showMessage('рж▓рзЗржиржжрзЗржи рж╕рзЗржн рж╣рзЯрзЗржЫрзЗ'); 
    });

    document.getElementById('fund-list-container').addEventListener('submit', async e => { 
        e.preventDefault();
        const form = e.target;
        
        if(form.classList.contains('assign-fund-form')) { 
            const amt = Number(form.querySelector('input').value), rid = form.querySelector('select').value, mk = form.dataset.month; 
            const globalFund = calculateAvailableFund();
            if(amt > globalFund) return showMessage('рждрж╣ржмрж┐рж▓рзЗ ржкрж░рзНржпрж╛ржкрзНржд ржЯрж╛ржХрж╛ ржирзЗржЗред', 'error');
            if(await showConfirmation('рждрж╣ржмрж┐рж▓ ржкрзНрж░ржжрж╛ржи ржХрж░ржмрзЗржи?')) { 
                const mm = JSON.parse(JSON.stringify(members)); 
                mm.find(m=>m.id===rid).transactions.push({ id: 'T'+Date.now(), date: mk+'-01', type: 'loanTaken', amount: amt, description: 'рждрж╣ржмрж┐рж▓' }); 
                await updateData({ members: mm, fundDistribution: { ...fundDistribution, [mk]: { receiverId: rid, amount: amt } } }); 
                renderFundModal(); 
                showMessage('ржкрзНрж░ржжрж╛ржи ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ'); 
            } 
        } else if (form.classList.contains('edit-fund-form')) {
            const mk = form.dataset.month;
            const newRid = form.receiverId.value;
            const newAmt = Number(form.amount.value);
            
            const oldDist = fundDistribution[mk];
            const mm = JSON.parse(JSON.stringify(members));
            
            // Logic to update transaction without breaking anything
            // 1. Find old transaction
            const oldReceiver = mm.find(m => m.id === oldDist.receiverId);
            const txIndex = oldReceiver.transactions.findIndex(t => t.date === mk+'-01' && t.type === 'loanTaken' && t.amount === oldDist.amount); // Simple match
            
            if (txIndex === -1) {
                // Fallback: Create new if missing (should generally not happen)
                if (newRid === oldDist.receiverId) {
                     mm.find(m=>m.id===newRid).transactions.push({ id: 'T'+Date.now(), date: mk+'-01', type: 'loanTaken', amount: newAmt, description: 'рждрж╣ржмрж┐рж▓' });
                }
            } else {
                if (newRid === oldDist.receiverId) {
                    // Same person, just update amount
                    oldReceiver.transactions[txIndex].amount = newAmt;
                } else {
                    // Person changed
                    // Remove from old
                    oldReceiver.transactions.splice(txIndex, 1);
                    // Add to new
                    mm.find(m=>m.id===newRid).transactions.push({ id: 'T'+Date.now(), date: mk+'-01', type: 'loanTaken', amount: newAmt, description: 'рждрж╣ржмрж┐рж▓' });
                }
            }

            await updateData({ members: mm, fundDistribution: { ...fundDistribution, [mk]: { receiverId: newRid, amount: newAmt } } });
            editingFundMonth = null;
            renderFundModal();
            showMessage('рждрж╣ржмрж┐рж▓ ржЖржкржбрзЗржЯ рж╣рзЯрзЗржЫрзЗ');
        }
    });

    // --- LOTTERY LOGIC ---
    let l_isAnimating = false;
    function initLottery() { resizeCanvas(); renderLottery(); }
    async function saveLotteryToFirebase() { try { await updateData({ lottery: lottery }); } catch (e) { showMessage("рж▓ржЯрж╛рж░рж┐ рж╕рзЗржн рж╕ржорж╕рзНржпрж╛", "error"); } }
    
    function renderLottery() {
        const listEl = document.getElementById("lotteryParticipants"), countBadge = document.getElementById("lotteryCountBadge"), historyEl = document.getElementById("lotteryHistory");
        const lp = lottery.participants, lh = lottery.history;
        countBadge.textContent = lp.length; listEl.innerHTML = "";
        if (lp.length === 0) listEl.innerHTML = `<li class="col-span-full text-center text-slate-500 italic py-10 text-lg">ржирж╛ржо ржирзЗржЗ</li>`;
        else lp.forEach((n, i) => {
            const li = document.createElement("li"); li.className = "group relative flex flex-col justify-center items-center bg-slate-800/80 border border-slate-700 p-4 rounded-xl hover:border-slate-500 hover:bg-slate-700/50";
            li.innerHTML = `<span class="absolute top-2 left-2 text-xs text-slate-500">#${i+1}</span><span class="font-semibold text-lg text-slate-200 truncate w-full text-center mt-2">${n}</span><button class="lottery-delete-btn absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-red-400" data-index="${i}">тЬЦ</button>`;
            listEl.appendChild(li);
        });
        document.querySelectorAll('.lottery-delete-btn').forEach(b => b.addEventListener('click', e => { e.stopPropagation(); deleteParticipant(parseInt(b.dataset.index)); }));
        historyEl.innerHTML = "";
        if (lh.length === 0) historyEl.innerHTML = `<li class="text-center text-slate-600 text-xs py-4">ржЗрждрж┐рж╣рж╛рж╕ ржирзЗржЗ</li>`;
        else lh.slice().reverse().forEach(h => { historyEl.innerHTML += `<li class="flex justify-between items-center bg-slate-900/50 p-3 rounded border-l-4 border-cyan-500"><span class="text-cyan-400 font-medium">${h.winner}</span><span class="text-slate-500 text-xs">${h.date}</span></li>`; });
    }
    
    document.getElementById("lotteryAddForm").addEventListener("submit", e => { e.preventDefault(); const i = document.getElementById("lotteryNameInput"), n = i.value.trim(); if(!n) return; lottery.participants.push(n); i.value=""; saveLotteryToFirebase(); renderLottery(); });
    
    function deleteParticipant(i) { if(l_isAnimating) return; lottery.participants.splice(i, 1); saveLotteryToFirebase(); renderLottery(); }
    
    function clearLotteryList() { if(l_isAnimating || lottery.participants.length===0) return; if(confirm("рж╕ржм ржирж╛ржо ржорзБржЫржмрзЗржи?")) { lottery.participants=[]; saveLotteryToFirebase(); renderLottery(); document.getElementById("lotteryWinnerSection").classList.add('hidden'); } }
    
    function clearLotteryHistory() { if(confirm("ржЗрждрж┐рж╣рж╛рж╕ ржорзБржЫржмрзЗржи?")) { lottery.history=[]; saveLotteryToFirebase(); renderLottery(); } }

    // TRIGGER FOR LIVE LOTTERY
    document.getElementById("lotteryDrawBtn").addEventListener("click", async () => {
        if (l_isAnimating || lottery.participants.length < 2) return alert("ржХржоржкржХрзНрж╖рзЗ рзиржЯрж┐ ржирж╛ржо ржкрзНрж░рзЯрзЛржЬржи!");
        
        // 1. Determine winner locally (The Admin decides)
        const winnerIndex = Math.floor(Math.random() * lottery.participants.length);
        
        // 2. Mark myself as the "drawer" so only I save the history to DB later
        iAmTheDrawer = true;

        // 3. Disable button immediately
        const btn = document.getElementById("lotteryDrawBtn"); 
        btn.disabled=true; 
        btn.textContent="ржбрзНрж░ рж╣ржЪрзНржЫрзЗ...";

        // 4. Update Firebase with the winner index and timestamp. 
        // This triggers the 'onSnapshot' for everyone (including me).
        try {
            await updateData({ 
                lottery: { 
                    ...lottery, 
                    liveDraw: { 
                        winnerIndex: winnerIndex, 
                        ts: Date.now() 
                    } 
                } 
            });
        } catch(e) {
            console.error("Failed to start live draw", e);
            btn.disabled=false;
            btn.textContent="ржбрзНрж░ рж╢рзБрж░рзБ ржХрж░рзБржи ЁЯО▓";
            iAmTheDrawer = false;
        }
    });

    // START ANIMATION (Called by onSnapshot)
    function startLiveLottery(winnerIndex) {
        l_isAnimating = true; 
        document.getElementById("lotteryWinnerSection").classList.add('hidden');
        const btn = document.getElementById("lotteryDrawBtn"); 
        btn.disabled=true; 
        btn.textContent="ржбрзНрж░ рж╣ржЪрзНржЫрзЗ...";
        
        const items = document.getElementById("lotteryParticipants").querySelectorAll("li");
        let cur = 0, cyc = 0;
        
        function anim() {
            items.forEach(i => i.classList.remove('active-highlight'));
            if(items[cur]) {
                items[cur].classList.add('active-highlight'); 
                items[cur].scrollIntoView({block:'center', behavior:'smooth'});
            }
            
            cur = (cur+1) % lottery.participants.length; 
            cyc++;
            
            // Animation Duration Logic
            if (cyc < 30 + Math.random()*10) { 
                setTimeout(anim, Math.min(100+cyc*2, 350));
            } else {
                finish(winnerIndex); // Pass the predetermined winner index
            }
        } 
        anim();
    }

    function finish(i) {
        const w = lottery.participants[i];
        const ws = document.getElementById("lotteryWinnerSection");
        
        document.getElementById("lotteryWinnerText").textContent = w;
        ws.classList.remove('hidden', 'animate-bounce'); 
        void ws.offsetWidth; 
        ws.classList.add('animate-bounce');
        
        // ONLY the person who clicked "Draw" saves the history to DB to avoid duplicates
        if (iAmTheDrawer) {
             lottery.history.push({ winner: w, date: new Date().toLocaleDateString('bn-BD') }); 
             saveLotteryToFirebase();
             iAmTheDrawer = false; 
        }

        startConfetti();
        l_isAnimating = false; 
        document.getElementById("lotteryDrawBtn").disabled=false; 
        document.getElementById("lotteryDrawBtn").textContent="ржбрзНрж░ рж╢рзБрж░рзБ ржХрж░рзБржи ЁЯО▓"; 
        renderLottery();
    }

    const canvas = document.getElementById("confetti"), ctx = canvas.getContext("2d");
    let parts = []; 
    function resizeCanvas() { canvas.width=window.innerWidth; canvas.height=window.innerHeight; }
    window.addEventListener('resize', resizeCanvas);
    
    function startConfetti() { parts=[]; for(let i=0;i<200;i++) parts.push({x:window.innerWidth/2, y:window.innerHeight/2, vx:(Math.random()-.5)*30, vy:(Math.random()-.5)*30, c:`hsl(${Math.random()*360},70%,50%)`}); updateConfetti(); }
    
    function updateConfetti() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        let act = false; parts.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=0.2; p.vx*=0.95; ctx.fillStyle=p.c; ctx.fillRect(p.x,p.y,8,8); if(p.y<canvas.height) act=true; });
        if(act) requestAnimationFrame(updateConfetti); else ctx.clearRect(0,0,canvas.width,canvas.height);
    }
  </script>
</body>
</html>