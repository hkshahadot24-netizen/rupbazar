<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡¶Æ‡ßá‡¶á‡¶® ‡¶ó‡ßá‡¶á‡¶ü ‡¶∏‡¶Æ‡¶¨‡¶æ‡¶Ø‡¶º ‡¶∏‡¶Æ‡¶ø‡¶§‡¶ø</title>
  <!-- Added typography plugin for better notice rendering -->
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600&family=Noto+Sans+Bengali:wght@400;700&display=swap" rel="stylesheet">
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* ‡¶´‡¶®‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü: 'Noto Sans Bengali' ‡¶™‡ßç‡¶∞‡¶ß‡¶æ‡¶® ‡¶´‡¶®‡ßç‡¶ü */
    body { font-family: 'Noto Sans Bengali', 'Hind Siliguri', sans-serif; }
    .spinner { border: 3px solid rgba(255,255,255,0.3); border-left-color: #ffffff; border-radius:50%; width:20px; height:20px; animation:spin 1s linear infinite;}
    .spinner-gray { border: 2px solid rgba(0,0,0,0.2); border-left-color: #4a5568; border-radius:50%; width:16px; height:16px; animation:spin 1s linear infinite;}
    @keyframes spin { 100% { transform: rotate(360deg);} }
    .modal-enter { opacity: 0; transform: scale(0.95); }
    .modal-enter-active { opacity: 1; transform: scale(1); transition: all 300ms ease-out; }
    .modal-exit { opacity: 1; transform: scale(1); }
    .modal-exit-active { opacity: 0; transform: scale(0.95); transition: all 300ms ease-in; }
    [type='date']::-webkit-calendar-picker-indicator {
        cursor: pointer;
        filter: invert(0.5) sepia(0.6) saturate(5) hue-rotate(200deg);
    }
    .tab-active {
        border-color: #4f46e5;
        color: #4f46e5;
        background-color: #eef2ff;
    }

    /* --- LOTTERY STYLES --- */
    #lottery-modal { font-family: 'Hind Siliguri', sans-serif; background-color: #0f172a; color: #f1f5f9; }
    #lottery-modal ::-webkit-scrollbar { width: 8px; }
    #lottery-modal ::-webkit-scrollbar-track { background: #1e293b; }
    #lottery-modal ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    .winner-highlight { animation: pulse 1s infinite; background: linear-gradient(45deg, #facc15, #fbbf24); color: #000 !important; transform: scale(1.05); box-shadow: 0 0 30px rgba(250, 204, 21, 0.6); border-color: #facc15 !important; }
    @keyframes pulse { 0%, 100% { transform: scale(1.02); } 50% { transform: scale(1.08); } }
    .lottery-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
    #confetti { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
    .active-highlight { background-color: #06b6d4; color: black; font-weight: bold; transform: scale(1.05); box-shadow: 0 0 15px rgba(6, 182, 212, 0.5); }
    
    /* Slideshow Transition */
    .slide-fade { transition: opacity 1s ease-in-out; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- Main Application Content (Hidden by default) -->
  <div id="main-app-content" class="hidden">
    
    <!-- Header -->
    <header class="w-full bg-gradient-to-r from-pink-600 to-red-600 text-white p-3 shadow-lg sticky top-0 z-40">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex flex-row justify-between items-center gap-4">
          <!-- Logo & Title -->
          <div class="flex items-center gap-3">
            <img id="header-logo-img" src="https://placehold.co/48x48/FFFFFF/F87171?text=‡¶≤‡ßã‡¶ó‡ßã" alt="‡¶≤‡ßã‡¶ó‡ßã" class="w-12 h-12 rounded-full border-2 border-white object-cover bg-white">
            <div class="flex-grow">
              <h1 class="text-2xl sm:text-3xl font-bold text-white py-0">
                ‡¶Æ‡ßá‡¶á‡¶® ‡¶ó‡ßá‡¶á‡¶ü ‡¶∏‡¶Æ‡¶¨‡¶æ‡¶Ø‡¶º ‡¶∏‡¶Æ‡¶ø‡¶§‡¶ø
              </h1>
              <p class="text-xs font-semibold text-pink-100"> ‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶ø‡¶§: ‡ß®‡ß¶‡ß®‡ß´</p>
              <p class="text-sm font-bold text-white mt-1">‚òÖ ‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡¶æ‡¶∏ ‚òÖ ‡¶Æ‡¶æ‡¶®‡¶¨‡¶ø‡¶ï‡¶§‡¶æ ‚òÖ ‡¶â‡¶®‡ßç‡¶®‡¶Ø‡¶º‡¶® ‚òÖ</p>
            </div>
          </div>
          
          <!-- Admin Panel Button -->
          <div>
            <button id="open-admin-btn" class="bg-white/10 hover:bg-white/20 text-white font-semibold py-2 px-4 rounded-lg backdrop-blur-sm transition flex items-center gap-2 border border-white/30 shadow-sm hover:shadow-md">
                <span class="text-xl">‚öôÔ∏è</span> 
                <span class="hidden sm:inline">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content Grid -->
    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 space-y-6">
      
      <!-- Content Column (Full Width Now) -->
      <div class="w-full space-y-6">
        
        <!-- Notice Board -->
        <div class="bg-white p-6 rounded-xl shadow-lg prose max-w-none">
          <div id="important-links-display" class="mb-4"></div>
          <div class="flex justify-end items-center mb-4 not-prose">
              <button id="edit-notice-btn" class="bg-gray-200 text-gray-700 py-1 px-3 rounded-lg font-semibold hover:bg-gray-300 transition text-sm">‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ</button>
          </div>
          <div id="notice-display" class="text-gray-700"></div>
          
          <!-- UPDATED NOTICE EDIT FORM -->
          <div id="notice-edit" class="hidden space-y-3 not-prose">
              <textarea id="notice-textarea" rows="4" class="w-full p-2 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="‡¶®‡ßã‡¶ü‡¶ø‡¶∂ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."></textarea>
              
              <!-- Changed to Textarea for multiple images -->
              <label class="block text-sm font-medium text-gray-700 mt-2">‡¶∏‡ßç‡¶≤‡¶æ‡¶á‡¶°‡¶∂‡ßã ‡¶á‡¶Æ‡ßá‡¶ú ‡¶≤‡¶ø‡¶Ç‡¶ï (‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ï‡¶∞‡ßá ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶¶‡¶ø‡¶®)</label>
              <textarea id="notice-image-urls" rows="3" class="w-full p-2 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500 font-mono text-sm" placeholder="https://example.com/image1.jpg&#10;https://example.com/image2.jpg"></textarea>
              
              <input id="notice-link-text" type="text" class="w-full p-2 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="‡¶≤‡¶ø‡¶Ç‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ (‡¶Ø‡ßá‡¶Æ‡¶®: '‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®')">
              <input id="notice-link-url" type="url" class="w-full p-2 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶≤‡¶ø‡¶Ç‡¶ï (https://...)">

              <div class="pt-4 border-t mt-4">
                  <h5 class="text-md font-semibold text-gray-700 mb-2">‡¶®‡¶§‡ßÅ‡¶® ‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</h5>
                  <div class="space-y-2">
                      <input id="new-link-name" type="text" class="w-full p-2 border rounded-lg" placeholder="‡¶≤‡¶ø‡¶Ç‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ (‡¶Ø‡ßá‡¶Æ‡¶®: '‡¶´‡ßá‡¶∏‡¶¨‡ßÅ‡¶ï ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™')">
                      <input id="new-link-url" type="url" class="w-full p-2 border rounded-lg" placeholder="‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶≤‡¶ø‡¶Ç‡¶ï (https://...)">
                      <button id="save-new-link-btn" type="button" class="bg-blue-600 text-white py-2 px-3 rounded-lg font-bold hover:bg-blue-700 transition text-sm flex items-center gap-2">
                          <span>‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶∏‡ßá‡¶≠</span>
                          <div class="spinner hidden"></div>
                      </button>
                  </div>
              </div>

              <div class="flex gap-3 pt-4 border-t">
                  <button id="save-notice-btn" class="bg-green-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-green-700 transition flex items-center gap-2">
                      <span>‡¶®‡ßã‡¶ü‡¶ø‡¶∂ ‡¶∏‡ßá‡¶≠</span>
                      <div class="spinner hidden"></div>
                  </button>
                  <button id="cancel-notice-btn" class="bg-gray-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-gray-600 transition">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
              </div>
          </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="bg-white p-6 rounded-xl shadow-lg text-center transition-transform hover:scale-105">
            <h3 class="text-lg font-semibold text-gray-500 mb-2">‡¶Æ‡ßã‡¶ü ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø</h3>
            <p id="total-members" class="text-4xl font-bold text-indigo-600">‡ß¶</p>
          </div>
          <div class="bg-white p-6 rounded-xl shadow-lg text-center transition-transform hover:scale-105">
            <h3 class="text-lg font-semibold text-gray-500 mb-2">‡¶Æ‡ßã‡¶ü ‡¶ú‡¶Æ‡¶æ</h3>
            <p id="total-paid" class="text-4xl font-bold text-green-600">‡ß≥ ‡ß¶</p>
          </div>
          <div class="bg-white p-6 rounded-xl shadow-lg text-center transition-transform hover:scale-105">
            <h3 class="text-lg font-semibold text-gray-500 mb-2">‡¶Æ‡ßã‡¶ü ‡¶ã‡¶£ ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶®</h3>
            <p id="total-loan-given" class="text-4xl font-bold text-red-600">‡ß≥ ‡ß¶</p>
          </div>
        </div>

        <!-- CHARTS SECTION (NEW) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Financial Overview Chart -->
            <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg flex flex-col">
                <h3 class="text-lg font-bold text-gray-700 mb-4 text-center border-b pb-2">‡¶Ü‡¶∞‡ßç‡¶•‡¶ø‡¶ï ‡¶∏‡¶æ‡¶∞‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡ßá‡¶™</h3>
                <div class="flex-grow relative h-64 sm:h-80 w-full">
                    <canvas id="financeChart"></canvas>
                </div>
            </div>
            
            <!-- Monthly Trend Chart -->
            <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg flex flex-col">
                <h3 class="text-lg font-bold text-gray-700 mb-4 text-center border-b pb-2">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶ú‡¶Æ‡¶æ‡¶∞ ‡¶π‡¶æ‡¶∞</h3>
                <div class="flex-grow relative h-64 sm:h-80 w-full">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Monthly Lottery Banner -->
        <div class="bg-[#0f172a] p-6 rounded-xl shadow-xl flex flex-col sm:flex-row justify-between items-center gap-4 border border-slate-800 relative overflow-hidden group">
            <div class="absolute top-0 right-0 w-64 h-64 bg-blue-600/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
            <div class="flex items-center gap-4 z-10">
                <div class="bg-slate-800 p-3 rounded-xl shadow-inner border border-slate-700">
                    <span class="text-3xl">üé≤</span>
                </div>
                <div>
                    <h3 class="text-2xl font-bold text-cyan-400">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶≤‡¶ü‡¶æ‡¶∞‡¶ø</h3>
                    <p class="text-slate-400 text-sm font-medium">‡¶≠‡¶æ‡¶ó‡ßç‡¶Ø ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ì ‡¶´‡¶≤‡¶æ‡¶´‡¶≤</p>
                </div>
            </div>
            <div class="z-10 w-full sm:w-auto">
                <button id="main-lottery-btn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-xl shadow-lg shadow-blue-600/30 transition transform hover:scale-105 active:scale-95 flex justify-center items-center gap-2">
                    ‡¶≤‡¶ü‡¶æ‡¶∞‡¶ø ‡¶°‡ßç‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
        </div>

        <!-- Add Member Form -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
          <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-3">‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
          <form id="add-member-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input id="member-name" type="text" placeholder="‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ (‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï)" class="p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
            <input id="member-phone" type="text" placeholder="‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ (‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï)" class="p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
            <input id="member-photo-url" type="url" placeholder="‡¶õ‡¶¨‡¶ø‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)" class="p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <input id="member-employee-id" type="text" placeholder="‡¶è‡¶Æ‡¶™‡ßç‡¶≤‡¶Ø‡¶º‡¶ø ‡¶Ü‡¶á‡¶°‡¶ø (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)" class="p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <input id="member-card-number" type="text" placeholder="‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)" class="p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <input id="member-email" type="email" placeholder="‡¶á‡¶Æ‡ßá‡¶á‡¶≤ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)" class="p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <button type="submit" class="md:col-span-2 w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition duration-200 shadow-md disabled:opacity-50 flex justify-center items-center gap-2">
              <span>‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</span>
              <div class="spinner hidden"></div>
            </button>
          </form>
        </div>

        <!-- Member List -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
          <div class="p-4 sm:p-6 flex flex-col sm:flex-row justify-between sm:items-center gap-4 border-b">
            <h3 class="text-2xl font-bold text-gray-800">‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h3>
            <div class="space-x-2">
                <button id="open-fund-modal-btn" class="bg-blue-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-blue-700 transition duration-200 shadow-sm">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶§‡¶π‡¶¨‡¶ø‡¶≤</button>
            </div>
          </div>
          <div class="p-4 border-b">
              <!-- Updated Search Placeholder -->
              <input id="search-member-input" type="search" placeholder="‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶® (‡¶®‡¶æ‡¶Æ, ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤, ‡¶Ü‡¶á‡¶°‡¶ø, ‡¶ï‡¶æ‡¶∞‡ßç‡¶°...)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" autocomplete="off">
          </div>
          <div id="member-list-cards" class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
          <div id="member-list-placeholder" class="hidden p-6 text-center text-gray-500"></div>
        </div>
      </div> 
    </main>

    <!-- Sync Status -->
    <div id="sync-status" class="fixed bottom-4 right-4 bg-gray-800 text-white py-2 px-4 rounded-lg shadow-xl transition-opacity duration-300 opacity-0 z-50">
      <div class="flex items-center gap-2">
          <div id="sync-spinner" class="spinner-gray hidden"></div>
          <span id="sync-text">‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span>
      </div>
    </div>
    
    <!-- Message Box -->
    <div id="message-box" class="fixed top-5 left-1/2 -translate-x-1/2 z-[300] transition-opacity duration-300 opacity-0">
        <div id="message-content"></div>
    </div>
  </div>
  
  <!-- Verify Email Modal -->
  <div id="verify-email-modal" class="hidden fixed inset-0 bg-gray-100 z-[150] justify-center items-center p-4">
    <div class="bg-white w-full max-w-md p-8 rounded-xl shadow-2xl text-center">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
      <p class="text-gray-600 mb-6">‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ <strong id="user-email-info" class="text-indigo-600">...</strong> ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ‡ßü ‡¶è‡¶ï‡¶ü‡¶ø ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶™‡¶æ‡¶†‡¶ø‡ßü‡ßá‡¶õ‡¶ø‡•§</p>
      <div class="flex flex-col sm:flex-row gap-4">
        <button id="resend-verification-btn" class="flex-1 bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition duration-200">‡¶≤‡¶ø‡¶ô‡ßç‡¶ï‡¶ü‡¶ø ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
        <button id="logout-btn" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-400 transition duration-200">‡¶≤‡¶ó ‡¶Ü‡¶â‡¶ü</button>
      </div>
    </div>
  </div>

  <!-- Auth Modal -->
  <div id="auth-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 z-[200] justify-center items-center p-4 transition-opacity duration-300">
      <div class="bg-white w-full max-w-sm p-6 sm:p-8 rounded-xl shadow-2xl transition-transform duration-300 transform scale-95">
          <div class="flex border-b mb-6">
              <button id="login-tab" class="flex-1 py-2 text-center font-semibold border-b-2 tab-active">‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
              <button id="register-tab" class="flex-1 py-2 text-center font-semibold border-b-2 border-transparent text-gray-500">‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
          </div>
          <div id="login-view">
            <form id="login-form" class="space-y-4">
              <div><label class="block text-sm font-medium text-gray-700 mb-1">‡¶á‡¶Æ‡ßá‡¶á‡¶≤</label><input type="email" id="login-email" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></div>
              <div><label class="block text-sm font-medium text-gray-700 mb-1">‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°</label><input type="password" id="login-password" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></div>
              <p id="login-error" class="text-red-500 text-sm h-4"></p>
              <button id="login-button" type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition duration-200 shadow-md disabled:opacity-50 flex justify-center items-center gap-2"><span>‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®</span><div class="spinner hidden"></div></button>
            </form>
          </div>
          <div id="register-view" class="hidden">
            <form id="register-form" class="space-y-4">
              <div><label class="block text-sm font-medium text-gray-700 mb-1">‡¶á‡¶Æ‡ßá‡¶á‡¶≤</label><input type="email" id="register-email" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></div>
              <div><label class="block text-sm font-medium text-gray-700 mb-1">‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° (‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß¨ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞)</label><input type="password" id="register-password" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></div>
              <div><label class="block text-sm font-medium text-gray-700 mb-1">‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</label><input type="password" id="confirm-password" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></div>
              <p id="register-error" class="text-red-500 text-sm h-4"></p>
              <button id="register-button" type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition duration-200 shadow-md disabled:opacity-50 flex justify-center items-center gap-2"><span>‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</span><div class="spinner hidden"></div></button>
            </form>
          </div>
      </div>
  </div>

  <!-- Admin Modal (Fix: Ensure it can close) -->
  <div id="admin-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-[60] justify-center items-center p-4">
    <div id="admin-modal-box" class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 relative modal-exit">
      <button id="close-admin-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl font-bold cursor-pointer">&times;</button>
      <h3 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</h3>
      
      <!-- Logo Edit -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-1">‡¶≤‡ßã‡¶ó‡ßã ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ</label>
        <input id="logo-url-input" type="url" placeholder="‡¶≤‡ßã‡¶ó‡ßã ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¶‡¶ø‡¶®" class="w-full p-2 rounded-lg text-gray-800 text-sm border border-gray-300 focus:ring-2 focus:ring-pink-300 focus:outline-none">
        <button id="save-logo-btn" class="mt-2 w-full bg-white text-pink-600 py-2 px-4 rounded-lg font-bold hover:bg-pink-100 transition duration-200 text-sm flex-shrink-0 flex justify-center items-center gap-2 border border-pink-300">
          <span>‡¶≤‡ßã‡¶ó‡ßã ‡¶∏‡ßá‡¶≠</span>
          <div class="spinner-gray hidden"></div>
        </button>
      </div>
      
      <!-- Lottery Button -->
      <div class="mb-6">
         <button id="open-lottery-btn" class="w-full bg-gradient-to-r from-cyan-500 to-blue-600 text-white py-3 px-4 rounded-xl font-bold hover:scale-105 transition shadow-md flex justify-center items-center gap-2"><span>üé≤ ‡¶≤‡¶æ‡¶ï‡¶ø ‡¶≤‡¶ü‡¶æ‡¶∞‡¶ø</span></button>
      </div>

      <!-- Change Password Section -->
      <div class="mb-6 pt-4 border-t">
          <label class="block text-sm font-medium text-gray-700 mb-1">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</label>
          <input id="new-admin-password" type="password" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° (‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß¨ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞)" class="w-full p-2 rounded-lg text-gray-800 text-sm border border-gray-300 focus:ring-2 focus:ring-indigo-300 focus:outline-none">
          <button id="save-password-btn" class="mt-2 w-full bg-indigo-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-indigo-700 transition duration-200 text-sm flex justify-center items-center gap-2">
            <span>‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶Ü‡¶™‡¶°‡ßá‡¶ü</span>
            <div class="spinner hidden"></div>
          </button>
      </div>

      <!-- Logout -->
      <div class="pt-4 border-t">
        <button id="logout-main-btn" class="w-full bg-red-700 text-white py-2 px-4 rounded-lg font-bold hover:bg-red-800 transition duration-200 text-sm">
          ‡¶≤‡¶ó ‡¶Ü‡¶â‡¶ü
        </button>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profile-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 justify-center items-center p-4">
    <div id="profile-modal-box" class="bg-white rounded-xl shadow-2xl w-full max-w-7xl p-6 relative h-[90vh] flex flex-col">
      <button id="close-profile" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl font-bold" title="‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®">&times;</button>
      <div id="profile-modal-content" class="flex flex-col h-full">
        <div class="flex flex-col items-center justify-center pt-2 pb-6 border-b">
            <img id="profile-header-img" src="https://placehold.co/96x96/EFEFEF/AAAAAA?text=?" alt="‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø‡ßá‡¶∞ ‡¶õ‡¶¨‡¶ø" class="w-24 h-24 rounded-full object-cover border-4 border-indigo-200 shadow-lg mb-3">
            <h2 id="profile-header-name" class="text-3xl font-bold text-indigo-700 truncate">‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</h2>
        </div>
        <div class="flex border-b border-gray-200 mb-6 flex-shrink-0">
            <button id="profile-tab-details" class="profile-tab tab-active flex items-center justify-center gap-2 py-3 px-6 font-semibold"><span class="hidden sm:inline">üë§</span><span>‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</span></button>
            <button id="profile-tab-transactions" class="profile-tab text-gray-500 flex items-center justify-center gap-2 py-3 px-6 font-semibold"><span class="hidden sm:inline">üßæ</span><span>‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®</span></button>
            <button id="profile-tab-summary" class="profile-tab text-gray-500 flex items-center justify-center gap-2 py-3 px-6 font-semibold"><span class="hidden sm:inline">üìà</span><span>‡¶∏‡¶æ‡¶∞-‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡ßá‡¶™</span></button>
        </div>
        <div id="profile-content-container" class="overflow-y-auto flex-grow">
            <!-- Details Panel -->
            <div id="profile-content-details">
                <div class="flex justify-end space-x-2 mb-4">
                    <button id="edit-profile-btn" class="bg-yellow-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-yellow-600 transition flex items-center gap-2"><span>‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ</span><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button>
                    <button id="save-profile-btn" class="hidden bg-green-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-green-600 transition flex items-center gap-2"><span>‡¶∏‡ßá‡¶≠</span><div id="save-profile-spinner" class="spinner hidden"></div></button>
                    <button id="cancel-edit-btn" class="hidden bg-gray-500 text-white py-2 px-4 rounded-lg font-bold hover:bg-gray-600 transition">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-4 text-sm">
                    <p class="text-gray-600 flex flex-col sm:col-span-2"><span class="font-semibold text-gray-800 mb-1">‡¶®‡¶æ‡¶Æ:</span><span id="profile-name-view" class="text-gray-900 bg-gray-100 p-2 rounded"></span><input id="profile-name-edit" type="text" class="hidden border rounded-lg p-2"></p>
                    <p class="text-gray-600 flex flex-col sm:col-span-2"><span class="font-semibold text-gray-800 mb-1">‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø:</span> <span id="profile-id" class="text-xs text-indigo-500 bg-gray-100 p-2 rounded select-all"></span></p>
                    <p class="text-gray-600 flex flex-col"><span class="font-semibold text-gray-800 mb-1">‡¶õ‡¶¨‡¶ø‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï:</span><span id="profile-photo-url-view" class="text-gray-900 bg-gray-100 p-2 rounded break-all"></span><input id="profile-photo-url-edit" type="url" class="hidden border rounded-lg p-2"></p>
                    <p class="text-gray-600 flex flex-col"><span class="font-semibold text-gray-800 mb-1">‡¶è‡¶Æ‡¶™‡ßç‡¶≤‡¶Ø‡¶º‡¶ø ‡¶Ü‡¶á‡¶°‡¶ø:</span><span id="profile-employee-id-view" class="text-gray-900 bg-gray-100 p-2 rounded"></span><input id="profile-employee-id-edit" type="text" class="hidden border rounded-lg p-2"></p>
                    <p class="text-gray-600 flex flex-col"><span class="font-semibold text-gray-800 mb-1">‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞:</span><span id="profile-card-number-view" class="text-gray-900 bg-gray-100 p-2 rounded"></span><input id="profile-card-number-edit" type="text" class="hidden border rounded-lg p-2"></p>
                    <p class="text-gray-600 flex flex-col"><span class="font-semibold text-gray-800 mb-1">‡¶á‡¶Æ‡ßá‡¶á‡¶≤:</span><span id="profile-email-view" class="text-gray-900 bg-gray-100 p-2 rounded break-all"></span><input id="profile-email-edit" type="email" class="hidden border rounded-lg p-2"></p>
                    <p class="text-gray-600 flex flex-col"><span class="font-semibold text-gray-800 mb-1">‡¶´‡ßã‡¶®:</span><span id="profile-phone-view" class="text-gray-900 bg-gray-100 p-2 rounded"></span><input id="profile-phone-edit" type="text" class="hidden border rounded-lg p-2"></p>
                    <p class="text-gray-600 flex flex-col sm:col-span-2"><span class="font-semibold text-gray-800 mb-1">‡¶®‡ßã‡¶ü:</span><span id="profile-notes-view" class="text-gray-900 bg-gray-100 p-2 rounded min-h-[50px] whitespace-pre-wrap"></span><textarea id="profile-notes-edit" rows="3" class="hidden border rounded-lg p-2"></textarea></p>
                </div>
                <div class="mt-8 pt-6 border-t text-center"><button id="delete-member-btn" class="bg-red-600 text-white py-2 px-6 rounded-lg font-bold hover:bg-red-700 transition duration-200 shadow-md">üóëÔ∏è ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶°‡¶ø‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button></div>
            </div>
            <!-- Transactions Panel -->
            <div id="profile-content-transactions" class="hidden h-full">
                <div class="flex justify-end mb-4 gap-2"><button id="open-transaction-modal-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-indigo-700 transition flex items-center gap-2"><span>‡¶®‡¶§‡ßÅ‡¶® ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®</span><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg></button></div>
                <div class="overflow-y-auto border rounded-lg shadow-inner h-full">
                    <table class="min-w-full bg-gray-50">
                        <thead class="bg-indigo-100 sticky top-0"><tr><th class="py-2 px-4 text-left text-xs font-medium text-gray-600 uppercase">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th class="py-2 px-4 text-left text-xs font-medium text-gray-600 uppercase">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th><th class="py-2 px-4 text-right text-xs font-medium text-gray-600 uppercase">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥)</th><th class="py-2 px-4 text-center text-xs font-medium text-gray-600 uppercase">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th></tr></thead>
                        <tbody id="transactions-table-body" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
            <!-- Summary Panel -->
            <div id="profile-content-summary" class="hidden">
                 <h3 class="text-2xl font-semibold text-green-600 border-b pb-2 pt-4 mb-6">üìà ‡¶∏‡¶æ‡¶∞‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡ßá‡¶™</h3>
                <div class="grid grid-cols-2 gap-4 text-center py-4">
                    <div><p class="text-sm text-gray-500">‡¶Æ‡ßã‡¶ü ‡¶ú‡¶Æ‡¶æ</p><p id="paid-total" class="text-2xl font-bold text-green-600">‡ß≥ ‡ß¶</p></div>
                    <div><p class="text-sm text-gray-500">‡¶Æ‡ßã‡¶ü ‡¶ã‡¶£ ‡¶ó‡ßç‡¶∞‡¶π‡¶£</p><p id="loan-taken" class="text-2xl font-bold text-blue-600">‡ß≥ ‡ß¶</p></div>
                    <div><p class="text-sm text-gray-500">‡¶Æ‡ßã‡¶ü ‡¶ã‡¶£ ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß</p><p id="loan-repaid" class="text-2xl font-bold text-yellow-600">‡ß≥ ‡ß¶</p></div>
                    <div><p class="text-sm text-gray-500">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶ã‡¶£</p><p id="current-loan" class="text-2xl font-bold text-red-600">‡ß≥ ‡ß¶</p></div>
                </div>
            </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Transaction Modal -->
  <div id="transaction-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 z-[60] flex justify-center items-center p-4">
    <div id="transaction-modal-box" class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 relative modal-exit m-auto">
        <button id="close-transaction-modal" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 text-3xl font-bold transition">&times;</button>
        <h3 id="transaction-modal-title" class="text-2xl font-bold mb-6 text-center text-indigo-600 border-b pb-2">‡¶ï‡¶ø‡¶∏‡ßç‡¶§‡¶ø/‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</h3>
        <form id="transaction-form" class="space-y-5">
            <input type="hidden" id="transaction-id" name="id">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1 text-center">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                <input type="date" id="transaction-date" name="date" required class="w-full p-3 border border-gray-300 rounded-xl text-center bg-gray-50 focus:ring-2 focus:ring-indigo-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1 text-center">‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡ßá‡¶∞ ‡¶ß‡¶∞‡¶®</label>
                <select id="transaction-type" name="type" required class="w-full p-3 border border-gray-300 rounded-xl bg-white text-center focus:ring-2 focus:ring-indigo-500 outline-none font-semibold">
                    <option value="deposit">‡¶ï‡¶ø‡¶∏‡ßç‡¶§‡¶ø/‡¶ú‡¶Æ‡¶æ</option>
                    <option value="loanTaken">‡¶ã‡¶£ ‡¶ó‡ßç‡¶∞‡¶π‡¶£</option>
                    <option value="loanRepayment">‡¶ã‡¶£ ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1 text-center">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥)</label>
                <input type="number" id="transaction-amount" name="amount" placeholder="‡ß¶.‡ß¶‡ß¶" required class="w-full p-4 border-2 border-indigo-100 rounded-xl text-center text-2xl font-bold text-indigo-700 focus:border-indigo-500 outline-none shadow-inner">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1 text-center">‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)</label>
                <textarea id="transaction-description" name="description" rows="2" class="w-full p-3 border border-gray-300 rounded-xl text-center focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."></textarea>
            </div>
            <button type="submit" class="w-full bg-gradient-to-r from-indigo-600 to-blue-600 text-white py-4 rounded-xl font-bold text-lg hover:shadow-lg hover:scale-[1.02] transition flex justify-center items-center gap-2">
                <span id="transaction-btn-text">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</span>
                <div id="transaction-spinner" class="spinner hidden"></div>
            </button>
        </form>
    </div>
  </div>

  <!-- Fund Modal -->
  <div id="fund-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 justify-center items-start p-4 pt-16">
      <div id="fund-modal-box" class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 relative modal-exit">
          <button id="close-fund-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl font-bold" title="‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®">&times;</button>
          <h3 class="text-2xl font-bold mb-6 text-center text-blue-600">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶§‡¶π‡¶¨‡¶ø‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ</h3>
          <div id="fund-list-container" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2"></div>
      </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-[70] justify-center items-center p-4">
        <div id="confirmation-modal-box" class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 text-center modal-exit">
            <p id="confirmation-message" class="text-lg mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-yes" class="bg-red-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-red-700">‡¶π‡ßç‡¶Ø‡¶æ‡¶Å</button>
                <button id="confirm-no" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-lg font-bold hover:bg-gray-400">‡¶®‡¶æ</button>
            </div>
        </div>
  </div>

  <!-- Lottery Modal -->
  <div id="lottery-modal" class="hidden fixed inset-0 z-[100] flex flex-col bg-[#0f172a]">
    <canvas id="confetti"></canvas>
    <div class="absolute top-4 left-4 z-50"><button id="close-lottery-btn" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-lg border border-slate-500"><span>‚¨Ö ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</span></button></div>
    <div class="w-full max-w-[1800px] mx-auto p-4 lg:p-8 grid grid-cols-1 lg:grid-cols-12 gap-6 lg:gap-8 grow mt-12 overflow-y-auto">
        <!-- Left Sidebar -->
        <div class="lg:col-span-4 flex flex-col gap-6">
            <div class="text-center"><h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600 mb-2">‡¶Æ‡ßá‡¶á‡¶® ‡¶ó‡ßá‡¶á‡¶ü ‡¶∏‡¶Æ‡¶¨‡¶æ‡¶Ø‡¶º ‡¶∏‡¶Æ‡¶ø‡¶§‡¶ø ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶≤‡¶ü‡¶æ‡¶∞‡¶ø</h1><p class="text-slate-400">‡¶≠‡¶æ‡¶ó‡ßç‡¶Ø ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡ßá‡¶∞‡¶æ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ</p></div>
            
            <!-- Input Form Centered -->
            <div class="lottery-card p-6 rounded-xl shadow-lg text-center">
                <form id="lotteryAddForm" class="flex flex-col gap-4 items-center">
                    <label class="text-lg text-slate-300 font-semibold">‡¶®‡¶§‡ßÅ‡¶® ‡¶Ö‡¶Ç‡¶∂‡¶ó‡ßç‡¶∞‡¶π‡¶£‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</label>
                    <div class="flex gap-2 w-full max-w-md">
                        <input id="lotteryNameInput" type="text" placeholder="‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." class="flex-1 bg-slate-800 border border-slate-600 text-white px-4 py-3 rounded-lg focus:outline-none focus:border-cyan-500 text-center transition-all focus:scale-105">
                        <button type="submit" class="bg-cyan-600 hover:bg-cyan-500 text-white px-6 py-3 rounded-lg font-semibold shadow-lg hover:shadow-cyan-500/50 transition-all">‡¶Ø‡ßã‡¶ó</button>
                    </div>
                </form>
            </div>

            <div class="flex gap-3"><button id="lotteryDrawBtn" class="flex-1 bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-500 hover:to-blue-500 text-white py-4 rounded-xl font-bold text-xl shadow-lg transition transform hover:scale-105 active:scale-95">‡¶°‡ßç‡¶∞ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶® üé≤</button><button id="lotteryClearListBtn" class="px-5 py-4 bg-slate-700 hover:bg-red-500/20 hover:text-red-400 text-slate-300 rounded-xl border border-slate-600 transition" title="‡¶∏‡¶¨ ‡¶®‡¶æ‡¶Æ ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®">üóëÔ∏è</button></div>
            <div class="lottery-card p-4 rounded-xl flex-1 min-h-[200px]"><div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2"><h2 class="text-lg font-semibold text-slate-300">üìú ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏</h2><button id="lotteryClearHistoryBtn" class="text-xs text-red-400 hover:text-red-300">‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button></div><ul id="lotteryHistory" class="space-y-2 max-h-[300px] overflow-y-auto pr-2 text-sm"></ul></div>
        </div>
        <!-- Right/Main Display -->
        <div class="lg:col-span-8 flex flex-col gap-6 h-full">
            <div id="lotteryWinnerSection" class="hidden w-full transition-all duration-500"><div class="lottery-card p-10 rounded-3xl border-4 border-yellow-500/50 shadow-[0_0_80px_rgba(234,179,8,0.5)] text-center bg-gradient-to-b from-slate-800/90 to-slate-900/95 backdrop-blur-xl transform scale-105"><h3 class="text-3xl text-yellow-400 mb-6 font-bold animate-pulse">üéâ ‡¶Ö‡¶≠‡¶ø‡¶®‡¶®‡ßç‡¶¶‡¶®! ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶¨‡¶ø‡¶ú‡ßü‡ßÄ üéâ</h3><div id="lotteryWinnerText" class="text-6xl md:text-8xl font-extrabold text-white break-words drop-shadow-[0_5px_5px_rgba(0,0,0,0.8)] tracking-wide"></div></div></div>
            <div class="lottery-card p-6 rounded-xl flex-1 flex flex-col shadow-xl h-full min-h-[400px]"><div class="flex justify-between items-center mb-4 px-2"><h2 class="text-2xl font-semibold text-slate-200">‡¶Ö‡¶Ç‡¶∂‡¶ó‡ßç‡¶∞‡¶π‡¶£‡¶ï‡¶æ‡¶∞‡ßÄ <span class="text-base font-normal text-slate-400 ml-2">(‡¶Æ‡ßã‡¶ü: <span id="lotteryCountBadge" class="text-cyan-400 font-bold">0</span>)</span></h2></div><ul id="lotteryParticipants" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3 overflow-y-auto pr-2 flex-1 content-start"><li class="col-span-full text-center text-slate-500 italic py-10 text-lg">‡¶ï‡ßã‡¶®‡ßã ‡¶®‡¶æ‡¶Æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø</li></ul></div>
        </div>
    </div>
    <footer class="w-full py-6 text-center border-t border-slate-800/50 mt-auto bg-[#0f172a]/50 backdrop-blur-sm"><p class="text-slate-500 text-sm font-mono">All rights reserved ¬© Sahadot 2025</p></footer>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, createUserWithEmailAndPassword, sendEmailVerification, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    setLogLevel('Debug');
    
    // --- FIREBASE CONFIGURATION (Reverted to your specific project config) ---
    const appId = 'default-samiti-app-id';
    const firebaseConfig = { apiKey: "AIzaSyBdfxO5LL9KfzJe-PhvaRbhDhz9G-QH1aE", authDomain: "sg-loan-online.firebaseapp.com", projectId: "sg-loan-online", storageBucket: "sg-loan-online.firebasestorage.app", messagingSenderId: "933667418231", appId: "1:933667418231:web:11c24150426bf869381672" };

    let app, db, auth;
    let members = [], fundDistribution = {}, notice = { text: '', imageUrls: [], linkText: '', linkUrl: '' }, logoUrl = '', importantLinks = [], lottery = { participants: [], history: [], liveDraw: null };
    let activeMember = null, isSaving = false, verificationCheckInterval = null, searchQuery = '';
    
    // NEW STATE FOR FUND EDITING
    let editingFundMonth = null;
    let noticeSlideInterval = null; // Variable for slideshow interval
    
    // CHARTS
    let financeChartInstance = null;
    let trendChartInstance = null;
    
    // Live Lottery Sync Variables
    let lastDrawTime = 0; 
    let iAmTheDrawer = false;
    let isFirstSnapshot = true;

    // --- UTILS ---
    const getBengaliNumber = (n) => { if (n == null || isNaN(n)) return "‡ß¶"; return new Intl.NumberFormat('bn-BD', { minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(n); };
    const formatDate = (d, f='long') => { if (!d) return ''; const dt = new Date(d); if(f==='monthYear') return dt.toLocaleString('bn-BD', {month:'long', year:'numeric'}); return `${new Intl.NumberFormat('bn-BD').format(dt.getDate())} ${dt.toLocaleString('bn-BD', {month:'long'})}, ${new Intl.NumberFormat('bn-BD').format(dt.getFullYear())}`; };
    const showMessage = (m, t='success') => { const b = document.getElementById('message-box'), c = document.getElementById('message-content'); c.className = `shadow-xl rounded-lg p-4 font-semibold text-white ${t==='error'?'bg-red-500':t==='info'?'bg-blue-500':'bg-green-500'} flex items-center space-x-2`; c.innerHTML = `<span>${m}</span>`; b.classList.remove('opacity-0'); setTimeout(() => b.classList.add('opacity-0'), 4000); };
    const showConfirmation = (msg) => new Promise(res => { document.getElementById('confirmation-message').textContent = msg; const box = document.getElementById('confirmation-modal-box'), m = document.getElementById('confirmation-modal'); const y = document.getElementById('confirm-yes'), n = document.getElementById('confirm-no'); const cl = (v) => { box.classList.remove('modal-enter-active'); box.classList.add('modal-exit-active'); setTimeout(() => { m.classList.add('hidden'); res(v); }, 300); }; const hy = () => { cleanup(); cl(true); }, hn = () => { cleanup(); cl(false); }, cleanup = () => { y.removeEventListener('click', hy); n.removeEventListener('click', hn); }; y.addEventListener('click', hy); n.addEventListener('click', hn); m.classList.remove('hidden'); m.classList.add('flex', 'modal-enter', 'modal-enter-active'); });
    const showSyncStatus = (t, s=false) => { document.getElementById('sync-text').textContent = t; document.getElementById('sync-status').classList.remove('opacity-0'); document.getElementById('sync-spinner').classList.toggle('hidden', !s); };
    const hideSyncStatus = () => setTimeout(() => document.getElementById('sync-status').classList.add('opacity-0'), 1500);
    const calculateMemberTotals = (m) => { const t = { totalDeposit: 0, totalLoanTaken: 0, totalLoanRepaid: 0, currentLoan: 0 }; (m?.transactions || []).forEach(tx => { const a = Number(tx.amount)||0; if(tx.type==='deposit') t.totalDeposit+=a; else if(tx.type==='loanTaken') t.totalLoanTaken+=a; else if(tx.type==='loanRepayment') t.totalLoanRepaid+=a; }); t.currentLoan = t.totalLoanTaken - t.totalLoanRepaid; return t; };
    const calculateAvailableFund = () => { let td=0, tlt=0, tlr=0; members.forEach(m => { const t = calculateMemberTotals(m); td+=t.totalDeposit; tlt+=t.totalLoanTaken; tlr+=t.totalLoanRepaid; }); return td + tlr - tlt; };

    // --- CHART RENDERING ---
    const renderCharts = (td, tlt, tlr) => {
        // 1. Finance Overview Bar Chart
        const ctxFinance = document.getElementById('financeChart').getContext('2d');
        if (financeChartInstance) financeChartInstance.destroy();
        
        financeChartInstance = new Chart(ctxFinance, {
            type: 'bar',
            data: {
                labels: ['‡¶Æ‡ßã‡¶ü ‡¶ú‡¶Æ‡¶æ', '‡¶ã‡¶£ ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶®', '‡¶ã‡¶£ ‡¶´‡ßá‡¶∞‡¶§'],
                datasets: [{
                    label: '‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡¶ü‡¶æ‡¶ï‡¶æ)',
                    data: [td, tlt, tlr],
                    backgroundColor: [
                        'rgba(22, 163, 74, 0.7)', // Green for Deposit
                        'rgba(220, 38, 38, 0.7)', // Red for Loan Given
                        'rgba(202, 138, 4, 0.7)'  // Yellow/Gold for Loan Repaid
                    ],
                    borderColor: [
                        'rgb(22, 163, 74)',
                        'rgb(220, 38, 38)',
                        'rgb(202, 138, 4)'
                    ],
                    borderWidth: 1,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: { label: (c) => `‡ß≥ ${getBengaliNumber(c.raw)}` }
                    }
                },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#f3f4f6' } },
                    x: { grid: { display: false } }
                }
            }
        });

        // 2. Monthly Trend Line Chart
        const monthlyData = {};
        members.forEach(m => {
            (m.transactions || []).forEach(t => {
                if (t.type === 'deposit') {
                    const month = t.date.substring(0, 7); // YYYY-MM
                    monthlyData[month] = (monthlyData[month] || 0) + Number(t.amount);
                }
            });
        });
        
        const sortedMonths = Object.keys(monthlyData).sort();
        const displayMonths = sortedMonths; 

        const labels = displayMonths.map(m => {
            const d = new Date(m + '-01');
            return d.toLocaleString('bn-BD', { month: 'short', year: 'numeric' });
        });
        const data = displayMonths.map(m => monthlyData[m]);

        const ctxTrend = document.getElementById('trendChart').getContext('2d');
        if (trendChartInstance) trendChartInstance.destroy();

        trendChartInstance = new Chart(ctxTrend, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶ú‡¶Æ‡¶æ',
                    data: data,
                    borderColor: 'rgb(79, 70, 229)', // Indigo
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgb(79, 70, 229)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: { label: (c) => `‡ß≥ ${getBengaliNumber(c.raw)}` }
                    }
                },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#f3f4f6' } },
                    x: { grid: { display: false } }
                }
            }
        });
    };

    // --- UI RENDERING ---
    const renderHeaderLogo = () => { const img = document.getElementById('header-logo-img'); img.src = logoUrl || 'https://placehold.co/48x48/FFFFFF/F87171?text=‡¶≤‡ßã‡¶ó‡ßã'; img.onerror = () => img.src = 'https://placehold.co/48x48/FFFFFF/F87171?text=‡¶≤‡ßã‡¶ó‡ßã'; document.getElementById('logo-url-input').value = logoUrl || ''; };
    const renderImportantLinks = () => {
        const c = document.getElementById('important-links-display'); if (importantLinks.length === 0) { c.innerHTML = ''; return; }
        c.innerHTML = `<h4 class="text-lg font-semibold text-gray-800 mb-2 not-prose">üîó ‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶≤‡¶ø‡¶Ç‡¶ï‡¶∏‡¶Æ‡ßÇ‡¶π</h4><div class="flex flex-wrap gap-2 not-prose">${importantLinks.map(l => `<a href="${l.url}" target="_blank" class="bg-indigo-100 text-indigo-700 text-sm font-medium px-3 py-1 rounded-full hover:bg-indigo-200 transition duration-200 flex items-center gap-2"><span>${l.name}</span><button class="delete-link-btn text-indigo-400 hover:text-indigo-600 font-bold" data-id="${l.id}">&times;</button></a>`).join('')}</div><hr class="my-4">`;
    };
    
    // MODIFIED RENDER NOTICE BOARD FUNCTION FOR SLIDESHOW
    const renderNoticeBoard = () => {
        const d = document.getElementById('notice-display'); d.innerHTML = '';
        if (noticeSlideInterval) clearInterval(noticeSlideInterval);

        // Normalize images: legacy `imageUrl` or new `imageUrls`
        let images = [];
        if (Array.isArray(notice.imageUrls)) {
            images = notice.imageUrls.filter(u => u.trim() !== '');
        } else if (notice.imageUrl) {
            images = [notice.imageUrl];
        }

        if (images.length === 0 && !notice.text && !notice.linkUrl) {
            d.innerHTML = '<p class="text-gray-500">‡¶Ü‡¶™‡¶æ‡¶§‡¶§ ‡¶ï‡ßã‡¶®‡ßã ‡¶®‡¶§‡ßÅ‡¶® ‡¶®‡ßã‡¶ü‡¶ø‡¶∂ ‡¶®‡ßá‡¶á‡•§</p>'; return;
        }

        // Render Images (Single or Slideshow)
        if (images.length > 0) {
            if (images.length === 1) {
                // Single Image
                d.innerHTML += `<img src="${images[0]}" class="w-full h-auto rounded-lg mb-4 mx-auto shadow-sm" onerror="this.style.display='none'">`;
            } else {
                // Slideshow
                let slidesHtml = images.map((url, i) =>
                    `<img src="${url}" class="notice-slide absolute inset-0 w-full h-full object-cover transition-opacity duration-1000 ease-in-out ${i === 0 ? 'opacity-100' : 'opacity-0'}" onerror="this.style.display='none'">`
                ).join('');

                // Render Container
                d.innerHTML += `
                    <div class="relative w-full h-64 sm:h-80 md:h-96 bg-gray-100 rounded-lg overflow-hidden mb-4 shadow-sm border border-gray-200">
                        ${slidesHtml}
                        <div class="absolute bottom-2 left-0 right-0 flex justify-center gap-2 z-10 pointer-events-none">
                            ${images.map((_, i) => `<div class="w-2 h-2 rounded-full bg-white/60 ${i===0?'bg-white scale-125':''} shadow transition-all dot-indicator" data-index="${i}"></div>`).join('')}
                        </div>
                    </div>
                `;

                // Logic
                let currentSlide = 0;
                noticeSlideInterval = setInterval(() => {
                    const slides = document.querySelectorAll('.notice-slide');
                    const dots = document.querySelectorAll('.dot-indicator');
                    if (slides.length === 0) return;

                    // Hide current
                    slides[currentSlide].classList.remove('opacity-100');
                    slides[currentSlide].classList.add('opacity-0');
                    if(dots[currentSlide]) dots[currentSlide].classList.remove('bg-white', 'scale-125');

                    // Next
                    currentSlide = (currentSlide + 1) % slides.length;

                    // Show next
                    slides[currentSlide].classList.remove('opacity-0');
                    slides[currentSlide].classList.add('opacity-100');
                    if(dots[currentSlide]) dots[currentSlide].classList.add('bg-white', 'scale-125');

                }, 4000); // 4 seconds
            }
        }

        if (notice.text) d.innerHTML += `<div>${notice.text.split('\n').map(l => `<p>${l}</p>`).join('')}</div>`;
        if (notice.linkUrl) d.innerHTML += `<a href="${notice.linkUrl}" target="_blank" class="inline-block bg-indigo-600 text-white font-bold py-2 px-5 rounded-lg mt-4 no-underline hover:bg-indigo-700 transition">${notice.linkText||'‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§'}</a>`;
    };

    const renderUI = () => {
        let td = 0, tlt = 0, tlr = 0; 
        members.forEach(m => { 
            const t = calculateMemberTotals(m); 
            td += t.totalDeposit; 
            tlt += t.totalLoanTaken; 
            tlr += t.totalLoanRepaid; 
        });
        
        document.getElementById('total-members').textContent = getBengaliNumber(members.length);
        document.getElementById('total-paid').textContent = `‡ß≥ ${getBengaliNumber(td)}`;
        document.getElementById('total-loan-given').textContent = `‡ß≥ ${getBengaliNumber(tlt)}`;
        
        // RENDER CHARTS
        renderCharts(td, tlt, tlr);

        const c = document.getElementById('member-list-cards'), p = document.getElementById('member-list-placeholder'); c.innerHTML = '';
        
        // --- UPDATED SEARCH LOGIC ---
        const fm = members.filter(m => { 
            const q = searchQuery.toLowerCase(); 
            return (m.name||'').toLowerCase().includes(q) || 
                   (m.id||'').toLowerCase().includes(q) || 
                   (m.cardNumber||'').toLowerCase().includes(q) ||
                   (m.phone||'').includes(q) ||
                   (m.employeeId||'').toLowerCase().includes(q);
        });
        
        if (fm.length === 0) { p.classList.remove('hidden'); p.textContent = searchQuery ? '‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§' : '‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶®‡ßá‡¶á‡•§'; }
        else {
            p.classList.add('hidden');
            fm.sort((a,b)=>a.name.localeCompare(b.name, 'bn')).forEach(m => {
                const t = calculateMemberTotals(m);
                c.innerHTML += `<div class="bg-white rounded-lg shadow-md border border-gray-200 p-4 flex flex-col transition-transform hover:scale-[1.02] duration-200">
                    <div class="flex items-center gap-4 mb-4"><img class="h-16 w-16 rounded-full object-cover border-2 border-indigo-200" src="${m.photoUrl||`https://placehold.co/64x64/EFEFEF/AAAAAA?text=${m.name[0]}`}" onerror="this.src='https://placehold.co/64x64/EFEFEF/AAAAAA?text=?'"><div class="overflow-hidden"><h4 class="text-lg font-bold text-gray-900 truncate">${m.name}</h4><p class="text-sm text-gray-600">‡¶ï‡¶æ‡¶∞‡ßç‡¶°: ${m.cardNumber||'N/A'}</p><p class="text-sm text-gray-600">‡¶´‡ßã‡¶®: ${m.phone}</p></div></div>
                    <div class="space-y-2 flex-grow"><div class="flex justify-between bg-green-50 p-2 rounded-md"><span class="text-sm font-medium text-green-700">‡¶Æ‡ßã‡¶ü ‡¶ú‡¶Æ‡¶æ:</span><span class="text-lg font-bold text-green-600">‡ß≥ ${getBengaliNumber(t.totalDeposit)}</span></div><div class="flex justify-between bg-red-50 p-2 rounded-md"><span class="text-sm font-medium text-red-700">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶ã‡¶£:</span><span class="text-lg font-bold text-red-600">‡ß≥ ${getBengaliNumber(t.currentLoan)}</span></div></div>
                    <button class="view-profile-btn mt-4 w-full bg-indigo-500 text-white px-3 py-2 rounded-lg text-sm font-bold hover:bg-indigo-600" data-id="${m.id}">‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button></div>`;
            });
        }
        if (activeMember && !fm.find(m => m.id === activeMember.id)) closeProfileModal();
        else if (activeMember) showProfile(activeMember.id, false);
    };
    
    const toggleProfileEditMode = (isEditing) => {
        document.querySelectorAll('#profile-content-details [id$="-view"]').forEach(el => el.classList.toggle('hidden', isEditing));
        document.querySelectorAll('#profile-content-details [id$="-edit"]').forEach(el => el.classList.toggle('hidden', !isEditing));
        document.getElementById('edit-profile-btn').classList.toggle('hidden', isEditing);
        document.getElementById('save-profile-btn').classList.toggle('hidden', !isEditing);
        document.getElementById('cancel-edit-btn').classList.toggle('hidden', !isEditing);
    };

    const showProfile = (id, anim=true) => {
        const m = members.find(x => x.id === id); activeMember = m; if (!m) return;
        toggleProfileEditMode(false);
        const t = calculateMemberTotals(m);
        document.getElementById('profile-header-img').src = m.photoUrl || `https://placehold.co/96x96/EFEFEF/AAAAAA?text=${m.name[0]}`;
        document.getElementById('profile-header-name').textContent = m.name;
        ['name','id','photo-url','employee-id','card-number','email','phone','notes'].forEach(k => {
            const v = document.getElementById(`profile-${k}-view`); const e = document.getElementById(`profile-${k}-edit`);
            const val = m[k.replace(/-/g,'')] || m[k==='photo-url'?'photoUrl':k==='employee-id'?'employeeId':k==='card-number'?'cardNumber':k] || 'N/A';
            if(v) v.textContent = val; if(e) e.value = val === 'N/A' ? '' : val;
        });
        document.getElementById('paid-total').textContent = `‡ß≥ ${getBengaliNumber(t.totalDeposit)}`;
        document.getElementById('loan-taken').textContent = `‡ß≥ ${getBengaliNumber(t.totalLoanTaken)}`;
        document.getElementById('loan-repaid').textContent = `‡ß≥ ${getBengaliNumber(t.totalLoanRepaid)}`;
        document.getElementById('current-loan').textContent = `‡ß≥ ${getBengaliNumber(t.currentLoan)}`;
        
        document.getElementById('transactions-table-body').innerHTML = (m.transactions||[]).length===0 ? '<tr><td colspan="4" class="py-4 text-center text-gray-500">‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶®‡ßá‡¶á‡•§</td></tr>' :
            [...m.transactions].sort((a,b)=>new Date(b.date)-new Date(a.date)).map(tx => {
                const clr = tx.type==='deposit'?'text-green-600':tx.type==='loanTaken'?'text-blue-600':'text-yellow-700';
                const typ = tx.type==='deposit'?'‡¶ï‡¶ø‡¶∏‡ßç‡¶§‡¶ø/‡¶ú‡¶Æ‡¶æ':tx.type==='loanTaken'?'‡¶ã‡¶£ ‡¶ó‡ßç‡¶∞‡¶π‡¶£':'‡¶ã‡¶£ ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß';
                return `<tr class="hover:bg-gray-100"><td class="py-2 px-4 text-sm">${formatDate(tx.date)}</td><td class="py-2 px-4 text-sm">${typ}${tx.linkedDepositId?' üîó':''}<br><span class="text-xs text-gray-500">${tx.description||''}</span></td><td class="py-2 px-4 text-right font-mono font-semibold ${clr}">${getBengaliNumber(tx.amount)}</td><td class="py-2 px-4 text-center space-x-2"><button class="edit-transaction-btn text-blue-500" data-tid="${tx.id}" ${tx.linkedDepositId?'disabled':''}>‚úèÔ∏è</button><button class="delete-transaction-btn text-red-500" data-tid="${tx.id}" ${tx.linkedDepositId?'disabled':''}>üóëÔ∏è</button></td></tr>`;
            }).join('');

        document.getElementById('profile-modal').classList.remove('hidden', 'flex');
        document.getElementById('profile-modal').classList.add('flex');
        if (anim) { document.getElementById('profile-modal-box').classList.add('modal-enter-active'); }
    };
    const closeProfileModal = () => { document.getElementById('profile-modal').classList.add('hidden'); activeMember = null; };
    
    const openTransactionModal = (tid=null) => {
        document.getElementById('transaction-form').reset();
        document.getElementById('transaction-id').value = tid || '';
        document.getElementById('transaction-date').valueAsDate = new Date();
        document.getElementById('transaction-type').disabled = !!tid;
        document.getElementById('transaction-modal-title').textContent = tid ? "‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ" : "‡¶®‡¶§‡ßÅ‡¶® ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®";
        if(tid) {
            const tx = activeMember.transactions.find(t=>t.id===tid);
            if(tx) {
                const f = document.getElementById('transaction-form');
                f.id.value=tx.id; f.date.value=tx.date; f.type.value=tx.type; f.amount.value=tx.amount; f.description.value=tx.description||'';
            }
        }
        document.getElementById('transaction-modal').classList.remove('hidden');
        document.getElementById('transaction-modal').classList.add('flex');
    };
    const closeTransactionModal = () => document.getElementById('transaction-modal').classList.add('hidden');

    const renderFundModal = () => {
        const c = document.getElementById('fund-list-container');
        const md = {}; members.forEach(m => (m.transactions||[]).forEach(t => { if(t.type==='deposit') { const k = t.date.substring(0,7); md[k]=(md[k]||0)+Number(t.amount); } }));
        const g = calculateAvailableFund();
        const keys = Object.keys(md).sort().reverse();
        
        if (keys.length === 0) {
            c.innerHTML = '<div class="text-center text-gray-500">‡¶ï‡ßã‡¶®‡ßã ‡¶°‡ßá‡¶ü‡¶æ ‡¶®‡ßá‡¶á‡•§</div>';
            return;
        }

        c.innerHTML = keys.map(k => {
            const dist = fundDistribution[k]; 
            const r = dist ? members.find(m=>m.id===dist.receiverId) : null;
            const max = Math.min(g, md[k]);
            const isEditing = editingFundMonth === k;

            let content = '';
            
            if (isEditing && dist) {
                content = `
                    <div class="mt-3 p-3 border border-blue-200 rounded-lg bg-blue-50">
                        <h5 class="text-sm font-bold text-blue-800 mb-2">‡¶§‡¶π‡¶¨‡¶ø‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</h5>
                        <form class="edit-fund-form space-y-3" data-month="${k}">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">‡¶™‡ßç‡¶∞‡¶æ‡¶™‡¶ï</label>
                                <select name="receiverId" required class="w-full p-2 border rounded-lg bg-white text-sm">
                                    ${members.map(m => `<option value="${m.id}" ${m.id === dist.receiverId ? 'selected' : ''}>${m.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥)</label>
                                <input type="number" name="amount" required class="w-full p-2 border rounded-lg text-sm" min="0" value="${dist.amount}">
                            </div>
                            <div class="flex gap-2 pt-1">
                                <button type="submit" class="bg-green-600 text-white px-3 py-1.5 rounded text-sm hover:bg-green-700">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                                <button type="button" class="cancel-fund-edit bg-gray-400 text-white px-3 py-1.5 rounded text-sm hover:bg-gray-500">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                            </div>
                        </form>
                    </div>
                `;
            } else if (r) {
                content = `
                    <div class="mt-3 p-3 bg-green-50 rounded-lg flex items-center justify-between gap-2 group">
                        <div class="flex items-center gap-4">
                            <img src="${r.photoUrl||`https://placehold.co/40x40?text=${r.name[0]}`}" class="w-12 h-12 rounded-full border-2 border-green-200 object-cover">
                            <div>
                                <p class="text-sm font-semibold text-green-700">‚úÖ ‡¶§‡¶π‡¶¨‡¶ø‡¶≤ ‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§:</p>
                                <p class="text-lg font-bold">${r.name}</p>
                                <p class="text-md font-semibold text-green-600">‡ß≥ ${getBengaliNumber(dist.amount)}</p>
                            </div>
                        </div>
                        <button class="edit-fund-btn bg-white border border-gray-200 p-2 rounded-full shadow-sm hover:bg-gray-100 text-blue-600 transition opacity-0 group-hover:opacity-100 focus:opacity-100" data-month="${k}" title="‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®">
                            ‚úèÔ∏è
                        </button>
                    </div>
                `;
            } else {
                content = `
                    <form class="assign-fund-form mt-3 space-y-2" data-month="${k}">
                        <p class="text-xs">‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡¶ã‡¶£‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø: <b>‡ß≥ ${getBengaliNumber(max)}</b></p>
                        <p class="text-xs text-gray-500">(‡¶§‡¶π‡¶¨‡¶ø‡¶≤‡ßá ‡¶Ö‡¶¨‡¶∂‡¶ø‡¶∑‡ßç‡¶ü: ‡ß≥ ${getBengaliNumber(g)})</p>
                        <select required class="w-full p-2 border rounded-lg bg-white">
                            <option value="">‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</option>
                            ${members.map(m=>`<option value="${m.id}">${m.name}</option>`).join('')}
                        </select>
                        <input type="number" required class="w-full p-2 border rounded-lg" min="0" max="${max}" data-max="${max}">
                        <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">‡¶ã‡¶£ ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    </form>
                `;
            }

            return `<div class="p-4 border rounded-lg shadow-sm bg-white">
                <h4 class="text-lg font-semibold text-blue-700">${formatDate(k+'-01','monthYear')}</h4>
                <p class="text-sm">‡¶Æ‡ßã‡¶ü ‡¶ú‡¶Æ‡¶æ: <b>‡ß≥ ${getBengaliNumber(md[k])}</b></p>
                ${content}
            </div>`;
        }).join('');
    };

    // --- FIREBASE OPS ---
    const initFirebase = () => { 
        try { 
            app = initializeApp(firebaseConfig); 
            db = getFirestore(app); 
            auth = getAuth(app); 

            // Initialize Auth State Listener HERE
            onAuthStateChanged(auth, u => {
                if (u && u.emailVerified) { document.getElementById('auth-modal').classList.add('hidden'); document.getElementById('verify-email-modal').classList.add('hidden'); document.getElementById('main-app-content').classList.remove('hidden'); listen(); }
                else if (u) { document.getElementById('user-email-info').textContent = u.email; document.getElementById('verify-email-modal').classList.remove('hidden'); document.getElementById('verify-email-modal').classList.add('flex'); document.getElementById('main-app-content').classList.add('hidden'); }
                else { document.getElementById('auth-modal').classList.remove('hidden'); document.getElementById('auth-modal').classList.add('flex'); document.getElementById('main-app-content').classList.add('hidden'); }
            });

        } catch(e) { 
            console.error(e);
            showMessage('‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶¨‡¶æ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ' + e.message, 'error'); 
        } 
    };
    
    const updateData = async (d) => { 
        if (isSaving) return; isSaving = true; showSyncStatus("‡¶∏‡¶ø‡¶ô‡ßç‡¶ï...", true); 
        try { 
            await setDoc(doc(db, 'artifacts', appId, 'public-data', 'main'), { 
                members: d.members!==undefined?d.members:members, 
                fundDistribution: d.fundDistribution!==undefined?d.fundDistribution:fundDistribution, 
                notice: d.notice!==undefined?d.notice:notice, 
                logoUrl: d.logoUrl!==undefined?d.logoUrl:logoUrl, 
                importantLinks: d.importantLinks!==undefined?d.importantLinks:importantLinks,
                lottery: d.lottery!==undefined?d.lottery:lottery 
            }); 
            showSyncStatus("‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá"); 
        } catch(e){ showMessage("‡¶∏‡ßá‡¶≠ ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•", 'error'); } finally { isSaving=false; hideSyncStatus(); } 
    };

    const listen = () => onSnapshot(doc(db, 'artifacts', appId, 'public-data', 'main'), s => {
        const d = s.data(); if(!d) return;
        members = d.members || []; fundDistribution = d.fundDistribution || {}; logoUrl = d.logoUrl || ''; importantLinks = d.importantLinks || [];
        
        // Handle Legacy Notice Structure vs New Structure
        if (d.notice) {
             if (typeof d.notice === 'string') {
                 notice = { text: d.notice, imageUrls: [], linkText: '', linkUrl: '' };
             } else {
                 notice = d.notice;
                 // Ensure imageUrls exists if only imageUrl was present
                 if (!notice.imageUrls && notice.imageUrl) {
                     notice.imageUrls = [notice.imageUrl];
                 } else if (!notice.imageUrls) {
                     notice.imageUrls = [];
                 }
             }
        } else {
            notice = { text: '', imageUrls: [], linkText: '', linkUrl: '' };
        }
        
        // Lottery Sync
        const dbLottery = d.lottery || { participants: [], history: [], liveDraw: null };
        lottery.participants = dbLottery.participants || [];
        lottery.history = dbLottery.history || [];
        
        if (dbLottery.liveDraw) {
            if (isFirstSnapshot) {
                lastDrawTime = dbLottery.liveDraw.ts;
            } else if (dbLottery.liveDraw.ts > lastDrawTime) {
                lastDrawTime = dbLottery.liveDraw.ts;
                if (!l_isAnimating) {
                   if (!document.getElementById('lottery-modal').classList.contains('hidden')) {
                       startLiveLottery(dbLottery.liveDraw.winnerIndex);
                   }
                }
            }
        }
        isFirstSnapshot = false;

        renderUI(); renderNoticeBoard(); renderHeaderLogo(); renderImportantLinks(); 
        if(!document.getElementById('fund-modal').classList.contains('hidden')) renderFundModal();
        if(!document.getElementById('lottery-modal').classList.contains('hidden') && !l_isAnimating) renderLottery();
    });

    // Initialize the app
    initFirebase();
    
    // --- EVENT LISTENERS ---
    document.getElementById('login-form').addEventListener('submit', async e => { e.preventDefault(); try { await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value); } catch(e){ document.getElementById('login-error').textContent='‡¶≠‡ßÅ‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø‡•§'; } });
    document.getElementById('register-form').addEventListener('submit', async e => { e.preventDefault(); const p = document.getElementById('register-password').value; if(p!==document.getElementById('confirm-password').value) return document.getElementById('register-error').textContent='‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶Æ‡¶ø‡¶≤‡¶õ‡ßá ‡¶®‡¶æ'; try { const c = await createUserWithEmailAndPassword(auth, document.getElementById('register-email').value, p); await sendEmailVerification(c.user); showMessage('‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§'); } catch(e){ document.getElementById('register-error').textContent='‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶® ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡•§'; } });
    document.getElementById('logout-main-btn').addEventListener('click', () => signOut(auth));
    document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
    document.getElementById('resend-verification-btn').addEventListener('click', async () => { if(auth.currentUser) await sendEmailVerification(auth.currentUser); showMessage('‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§'); });
    
    document.getElementById('add-member-form').addEventListener('submit', async e => { e.preventDefault(); const n = document.getElementById('member-name').value, p = document.getElementById('member-phone').value; if(!n||!p) return showMessage('‡¶®‡¶æ‡¶Æ ‡¶ì ‡¶´‡ßã‡¶® ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï', 'error'); await updateData({ members: [...members, { id: 'M'+Date.now(), name: n, phone: p, transactions: [], photoUrl: document.getElementById('member-photo-url').value, employeeId: document.getElementById('member-employee-id').value, cardNumber: document.getElementById('member-card-number').value, email: document.getElementById('member-email').value, notes: '' }] }); e.target.reset(); showMessage('‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá'); });
    document.getElementById('search-member-input').addEventListener('input', (e) => { searchQuery = e.target.value; renderUI(); });

    // ADMIN PASSWORD CHANGE LISTENER
    document.getElementById('save-password-btn').addEventListener('click', async () => {
        const newPass = document.getElementById('new-admin-password').value;
        if (!newPass || newPass.length < 6) return showMessage('‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡ß¨ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡ßá‡¶∞ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá', 'error');
        
        const btn = document.getElementById('save-password-btn');
        const spin = btn.querySelector('.spinner');
        const txt = btn.querySelector('span');
        
        txt.textContent = '‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
        spin.classList.remove('hidden');
        btn.disabled = true;

        try {
            const user = auth.currentUser;
            if (user) {
                await updatePassword(user, newPass);
                showMessage('‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                document.getElementById('new-admin-password').value = '';
                setTimeout(() => signOut(auth), 2000); // Auto logout for security
            } else {
                showMessage('‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶≤‡¶ó‡¶á‡¶® ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡ßü ‡¶®‡ßá‡¶á', 'error');
            }
        } catch (error) {
            console.error(error);
            if (error.code === 'auth/requires-recent-login') {
                showMessage('‡¶∏‡ßÅ‡¶∞‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'error');
            } else {
                showMessage('‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ' + error.message, 'error');
            }
        } finally {
            txt.textContent = '‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶Ü‡¶™‡¶°‡ßá‡¶ü';
            spin.classList.add('hidden');
            btn.disabled = false;
        }
    });

    document.addEventListener('click', async e => {
        const t = e.target.closest('button, svg'); if (!t) return;
        
        // Profile Tabs
        if (t.classList.contains('profile-tab')) {
            document.querySelectorAll('.profile-tab').forEach(x=>x.classList.remove('tab-active', 'text-indigo-600')); t.classList.add('tab-active', 'text-indigo-600');
            document.getElementById('profile-content-details').classList.toggle('hidden', t.id!=='profile-tab-details');
            document.getElementById('profile-content-transactions').classList.toggle('hidden', t.id!=='profile-tab-transactions');
            document.getElementById('profile-content-summary').classList.toggle('hidden', t.id!=='profile-tab-summary');
        }

        if (t.id==='login-tab' || t.id==='register-tab') { document.getElementById('login-tab').classList.toggle('tab-active'); document.getElementById('register-tab').classList.toggle('tab-active'); document.getElementById('login-view').classList.toggle('hidden'); document.getElementById('register-view').classList.toggle('hidden'); }
        if (t.id==='save-logo-btn') await updateData({ logoUrl: document.getElementById('logo-url-input').value });
        if (t.id==='save-new-link-btn') { const n = document.getElementById('new-link-name').value, u = document.getElementById('new-link-url').value; if(n&&u) { await updateData({ importantLinks: [...importantLinks, {id:'L'+Date.now(), name:n, url:u}] }); document.getElementById('new-link-name').value=''; document.getElementById('new-link-url').value=''; showMessage('‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá'); } }
        if (t.classList.contains('delete-link-btn')) { if(await showConfirmation('‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶Æ‡ßÅ‡¶õ‡¶¨‡ßá‡¶®?')) await updateData({ importantLinks: importantLinks.filter(l => l.id !== t.dataset.id) }); }
        
        if (t.classList.contains('view-profile-btn')) showProfile(t.dataset.id);
        if (t.id==='close-profile') closeProfileModal();
        if (t.id==='edit-profile-btn') toggleProfileEditMode(true);
        if (t.id==='cancel-edit-btn') { showProfile(activeMember.id, false); toggleProfileEditMode(false); }
        
        if (t.id==='save-profile-btn') { const u = { name: document.getElementById('profile-name-edit').value, phone: document.getElementById('profile-phone-edit').value, photoUrl: document.getElementById('profile-photo-url-edit').value, employeeId: document.getElementById('profile-employee-id-edit').value, cardNumber: document.getElementById('profile-card-number-edit').value, email: document.getElementById('profile-email-edit').value, notes: document.getElementById('profile-notes-edit').value }; const mm = JSON.parse(JSON.stringify(members)); Object.assign(mm.find(m=>m.id===activeMember.id), u); await updateData({ members: mm }); showMessage('‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá'); activeMember = mm.find(m=>m.id===activeMember.id); showProfile(activeMember.id, false); }
        if (t.id==='delete-member-btn') { if(await showConfirmation('‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶Æ‡ßÅ‡¶õ‡¶¨‡ßá‡¶®?')) { await updateData({ members: members.filter(m=>m.id!==activeMember.id) }); closeProfileModal(); showMessage('‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá'); } }
        
        if (t.id==='open-transaction-modal-btn') openTransactionModal();
        if (t.id==='close-transaction-modal') closeTransactionModal();
        if (t.classList.contains('edit-transaction-btn')) openTransactionModal(t.dataset.tid);
        if (t.classList.contains('delete-transaction-btn')) { 
             if(await showConfirmation('‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶Æ‡ßÅ‡¶õ‡¶¨‡ßá‡¶®?')) { 
                const mm = JSON.parse(JSON.stringify(members)); const m = mm.find(x=>x.id===activeMember.id); 
                m.transactions = m.transactions.filter(x => x.id !== t.dataset.tid && x.linkedDepositId !== t.dataset.tid); 
                await updateData({ members: mm }); showMessage('‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá'); showProfile(m.id, false); 
            } 
        }

        if (t.id==='open-fund-modal-btn') { editingFundMonth = null; renderFundModal(); document.getElementById('fund-modal').classList.remove('hidden'); document.getElementById('fund-modal').classList.add('flex'); }
        if (t.id==='close-fund-modal') document.getElementById('fund-modal').classList.add('hidden');
        
        if (t.classList.contains('edit-fund-btn')) { editingFundMonth = t.dataset.month; renderFundModal(); }
        if (t.classList.contains('cancel-fund-edit')) { editingFundMonth = null; renderFundModal(); }

        // --- UPDATED NOTICE LISTENERS ---
        if (t.id==='edit-notice-btn') { 
            document.getElementById('notice-display').classList.add('hidden'); 
            t.classList.add('hidden'); 
            document.getElementById('notice-edit').classList.remove('hidden'); 
            
            document.getElementById('notice-textarea').value=notice.text||''; 
            // Populate multiline text area
            document.getElementById('notice-image-urls').value = (notice.imageUrls || (notice.imageUrl ? [notice.imageUrl] : [])).join('\n');
            
            document.getElementById('notice-link-text').value=notice.linkText||''; 
            document.getElementById('notice-link-url').value=notice.linkUrl||''; 
            document.getElementById('new-link-name').value=''; 
            document.getElementById('new-link-url').value=''; 
        }
        
        if (t.id==='cancel-notice-btn') { 
            document.getElementById('notice-edit').classList.add('hidden'); 
            document.getElementById('notice-display').classList.remove('hidden'); 
            document.getElementById('edit-notice-btn').classList.remove('hidden'); 
        }
        
        if (t.id==='save-notice-btn') { 
            // Read lines, filter empty/spaces
            const rawUrls = document.getElementById('notice-image-urls').value;
            const urlArray = rawUrls.split('\n').map(l => l.trim()).filter(l => l !== '');
            
            await updateData({ 
                notice: { 
                    text: document.getElementById('notice-textarea').value, 
                    imageUrls: urlArray, // Save as array
                    imageUrl: urlArray[0] || '', // Fallback for backward compatibility
                    linkText: document.getElementById('notice-link-text').value, 
                    linkUrl: document.getElementById('notice-link-url').value 
                } 
            }); 
            
            document.getElementById('notice-edit').classList.add('hidden'); 
            document.getElementById('notice-display').classList.remove('hidden'); 
            document.getElementById('edit-notice-btn').classList.remove('hidden'); 
            showMessage('‡¶®‡ßã‡¶ü‡¶ø‡¶∂ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá'); 
        }
        
        // Admin & Lottery Triggers
        if (t.id === 'open-admin-btn' || t.closest('#open-admin-btn')) { document.getElementById('admin-modal').classList.remove('hidden'); document.getElementById('admin-modal').classList.add('flex'); }
        if (t.id === 'close-admin-modal' || t.closest('#close-admin-modal')) { 
            document.getElementById('admin-modal').classList.add('hidden'); 
            document.getElementById('admin-modal').classList.remove('flex'); 
        }

        if (t.id === 'open-lottery-btn' || t.closest('#open-lottery-btn')) { document.getElementById('admin-modal').classList.add('hidden'); document.getElementById('lottery-modal').classList.remove('hidden'); initLottery(); }
        if (t.id === 'main-lottery-btn' || t.closest('#main-lottery-btn')) { document.getElementById('lottery-modal').classList.remove('hidden'); initLottery(); }

        if (t.id === 'close-lottery-btn' || t.closest('#close-lottery-btn')) { document.getElementById('lottery-modal').classList.add('hidden'); }
        if (t.id === 'lotteryClearListBtn') clearLotteryList();
        if (t.id === 'lotteryClearHistoryBtn') clearLotteryHistory();
    });

    document.getElementById('transaction-form').addEventListener('submit', async e => { 
        e.preventDefault(); const f = e.target; const amt = Number(f.amount.value); if(amt<0) return; 
        const mm = JSON.parse(JSON.stringify(members)); const m = mm.find(x=>x.id===activeMember.id); 
        const d = { date: f.date.value, type: f.type.value, amount: amt, description: f.description.value };
        if(f.id.value) { 
            const idx = m.transactions.findIndex(x=>x.id===f.id.value); 
            const oldTx = m.transactions[idx]; m.transactions[idx] = { ...oldTx, ...d };
            if(d.type==='deposit') {
                const linkedIdx = m.transactions.findIndex(t=>t.linkedDepositId===f.id.value);
                const cur = calculateMemberTotals({ transactions: m.transactions.filter(t=>t.id!==f.id.value && t.linkedDepositId!==f.id.value) }).currentLoan;
                const rep = Math.min(amt, cur);
                if(linkedIdx>-1) { if(rep>0) { m.transactions[linkedIdx].amount=rep; m.transactions[linkedIdx].date=d.date; } else m.transactions.splice(linkedIdx,1); }
                else if(rep>0) m.transactions.push({ id:'T'+(Date.now()+1), date:d.date, type:'loanRepayment', amount:rep, description:'‡¶ï‡¶ø‡¶∏‡ßç‡¶§‡¶ø ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡ßç‡¶¨‡¶Ø‡¶º‡¶Ç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß', linkedDepositId:f.id.value });
            }
        } 
        else { 
            const nid = 'T'+Date.now(); m.transactions.push({ id: nid, ...d }); 
            if(d.type==='deposit') { const cur = calculateMemberTotals(m).currentLoan; if(cur>0) m.transactions.push({ id: 'T'+(Date.now()+1), date: d.date, type: 'loanRepayment', amount: Math.min(amt, cur), description: '‡¶ï‡¶ø‡¶∏‡ßç‡¶§‡¶ø ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡ßç‡¶¨‡¶Ø‡¶º‡¶Ç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß', linkedDepositId: nid }); } 
        }
        await updateData({ members: mm }); closeTransactionModal(); showProfile(m.id, false); showMessage('‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá'); 
    });

    document.getElementById('fund-list-container').addEventListener('submit', async e => { 
        e.preventDefault();
        const form = e.target;
        
        if(form.classList.contains('assign-fund-form')) { 
            const amt = Number(form.querySelector('input').value), rid = form.querySelector('select').value, mk = form.dataset.month; 
            const globalFund = calculateAvailableFund();
            if(amt > globalFund) return showMessage('‡¶§‡¶π‡¶¨‡¶ø‡¶≤‡ßá ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶®‡ßá‡¶á‡•§', 'error');
            if(await showConfirmation('‡¶§‡¶π‡¶¨‡¶ø‡¶≤ ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?')) { 
                const mm = JSON.parse(JSON.stringify(members)); 
                mm.find(m=>m.id===rid).transactions.push({ id: 'T'+Date.now(), date: mk+'-01', type: 'loanTaken', amount: amt, description: '‡¶§‡¶π‡¶¨‡¶ø‡¶≤' }); 
                await updateData({ members: mm, fundDistribution: { ...fundDistribution, [mk]: { receiverId: rid, amount: amt } } }); 
                renderFundModal(); 
                showMessage('‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá'); 
            } 
        } else if (form.classList.contains('edit-fund-form')) {
            const mk = form.dataset.month;
            const newRid = form.receiverId.value;
            const newAmt = Number(form.amount.value);
            
            const oldDist = fundDistribution[mk];
            const mm = JSON.parse(JSON.stringify(members));
            
            const oldReceiver = mm.find(m => m.id === oldDist.receiverId);
            const txIndex = oldReceiver.transactions.findIndex(t => t.date === mk+'-01' && t.type === 'loanTaken' && t.amount === oldDist.amount);
            
            if (txIndex === -1) {
                if (newRid === oldDist.receiverId) {
                     mm.find(m=>m.id===newRid).transactions.push({ id: 'T'+Date.now(), date: mk+'-01', type: 'loanTaken', amount: newAmt, description: '‡¶§‡¶π‡¶¨‡¶ø‡¶≤' });
                }
            } else {
                if (newRid === oldDist.receiverId) {
                    oldReceiver.transactions[txIndex].amount = newAmt;
                } else {
                    oldReceiver.transactions.splice(txIndex, 1);
                    mm.find(m=>m.id===newRid).transactions.push({ id: 'T'+Date.now(), date: mk+'-01', type: 'loanTaken', amount: newAmt, description: '‡¶§‡¶π‡¶¨‡¶ø‡¶≤' });
                }
            }

            await updateData({ members: mm, fundDistribution: { ...fundDistribution, [mk]: { receiverId: newRid, amount: newAmt } } });
            editingFundMonth = null;
            renderFundModal();
            showMessage('‡¶§‡¶π‡¶¨‡¶ø‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá');
        }
    });

    // --- LOTTERY LOGIC ---
    let l_isAnimating = false;
    function initLottery() { resizeCanvas(); renderLottery(); }
    async function saveLotteryToFirebase() { try { await updateData({ lottery: lottery }); } catch (e) { showMessage("‡¶≤‡¶ü‡¶æ‡¶∞‡¶ø ‡¶∏‡ßá‡¶≠ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ", "error"); } }
    
    function renderLottery() {
        const listEl = document.getElementById("lotteryParticipants"), countBadge = document.getElementById("lotteryCountBadge"), historyEl = document.getElementById("lotteryHistory");
        const lp = lottery.participants, lh = lottery.history;
        countBadge.textContent = lp.length; listEl.innerHTML = "";
        if (lp.length === 0) listEl.innerHTML = `<li class="col-span-full text-center text-slate-500 italic py-10 text-lg">‡¶®‡¶æ‡¶Æ ‡¶®‡ßá‡¶á</li>`;
        else lp.forEach((n, i) => {
            const li = document.createElement("li"); li.className = "group relative flex flex-col justify-center items-center bg-slate-800/80 border border-slate-700 p-4 rounded-xl hover:border-slate-500 hover:bg-slate-700/50";
            li.innerHTML = `<span class="absolute top-2 left-2 text-xs text-slate-500">#${i+1}</span><span class="font-semibold text-lg text-slate-200 truncate w-full text-center mt-2">${n}</span><button class="lottery-delete-btn absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-red-400" data-index="${i}">‚úñ</button>`;
            listEl.appendChild(li);
        });
        document.querySelectorAll('.lottery-delete-btn').forEach(b => b.addEventListener('click', e => { e.stopPropagation(); deleteParticipant(parseInt(b.dataset.index)); }));
        historyEl.innerHTML = "";
        if (lh.length === 0) historyEl.innerHTML = `<li class="text-center text-slate-600 text-xs py-4">‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶®‡ßá‡¶á</li>`;
        else lh.slice().reverse().forEach(h => { historyEl.innerHTML += `<li class="flex justify-between items-center bg-slate-900/50 p-3 rounded border-l-4 border-cyan-500"><span class="text-cyan-400 font-medium">${h.winner}</span><span class="text-slate-500 text-xs">${h.date}</span></li>`; });
    }
    
    document.getElementById("lotteryAddForm").addEventListener("submit", e => { e.preventDefault(); const i = document.getElementById("lotteryNameInput"), n = i.value.trim(); if(!n) return; lottery.participants.push(n); i.value=""; saveLotteryToFirebase(); renderLottery(); });
    
    function deleteParticipant(i) { if(l_isAnimating) return; lottery.participants.splice(i, 1); saveLotteryToFirebase(); renderLottery(); }
    
    function clearLotteryList() { if(l_isAnimating || lottery.participants.length===0) return; if(confirm("‡¶∏‡¶¨ ‡¶®‡¶æ‡¶Æ ‡¶Æ‡ßÅ‡¶õ‡¶¨‡ßá‡¶®?")) { lottery.participants=[]; saveLotteryToFirebase(); renderLottery(); document.getElementById("lotteryWinnerSection").classList.add('hidden'); } }
    
    function clearLotteryHistory() { if(confirm("‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶Æ‡ßÅ‡¶õ‡¶¨‡ßá‡¶®?")) { lottery.history=[]; saveLotteryToFirebase(); renderLottery(); } }

    // TRIGGER FOR LIVE LOTTERY
    document.getElementById("lotteryDrawBtn").addEventListener("click", async () => {
        if (l_isAnimating || lottery.participants.length < 2) return alert("‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß®‡¶ü‡¶ø ‡¶®‡¶æ‡¶Æ ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®!");
        const winnerIndex = Math.floor(Math.random() * lottery.participants.length);
        iAmTheDrawer = true;
        const btn = document.getElementById("lotteryDrawBtn"); 
        btn.disabled=true; 
        btn.textContent="‡¶°‡ßç‡¶∞ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";

        try {
            await updateData({ 
                lottery: { ...lottery, liveDraw: { winnerIndex: winnerIndex, ts: Date.now() } } 
            });
        } catch(e) {
            console.error("Failed to start live draw", e);
            btn.disabled=false; btn.textContent="‡¶°‡ßç‡¶∞ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶® üé≤"; iAmTheDrawer = false;
        }
    });

    function startLiveLottery(winnerIndex) {
        l_isAnimating = true; 
        document.getElementById("lotteryWinnerSection").classList.add('hidden');
        const btn = document.getElementById("lotteryDrawBtn"); 
        btn.disabled=true; btn.textContent="‡¶°‡ßç‡¶∞ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
        const items = document.getElementById("lotteryParticipants").querySelectorAll("li");
        let cur = 0, cyc = 0;
        function anim() {
            items.forEach(i => i.classList.remove('active-highlight'));
            if(items[cur]) { items[cur].classList.add('active-highlight'); items[cur].scrollIntoView({block:'center', behavior:'smooth'}); }
            cur = (cur+1) % lottery.participants.length; cyc++;
            if (cyc < 30 + Math.random()*10) { setTimeout(anim, Math.min(100+cyc*2, 350)); } else { finish(winnerIndex); }
        } 
        anim();
    }

    function finish(i) {
        const w = lottery.participants[i];
        const ws = document.getElementById("lotteryWinnerSection");
        document.getElementById("lotteryWinnerText").textContent = w;
        ws.classList.remove('hidden', 'animate-bounce'); void ws.offsetWidth; ws.classList.add('animate-bounce');
        if (iAmTheDrawer) { lottery.history.push({ winner: w, date: new Date().toLocaleDateString('bn-BD') }); saveLotteryToFirebase(); iAmTheDrawer = false; }
        startConfetti(); l_isAnimating = false; 
        document.getElementById("lotteryDrawBtn").disabled=false; document.getElementById("lotteryDrawBtn").textContent="‡¶°‡ßç‡¶∞ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶® üé≤"; renderLottery();
    }

    const canvas = document.getElementById("confetti"), ctx = canvas.getContext("2d");
    let parts = []; 
    function resizeCanvas() { canvas.width=window.innerWidth; canvas.height=window.innerHeight; }
    window.addEventListener('resize', resizeCanvas);
    function startConfetti() { parts=[]; for(let i=0;i<200;i++) parts.push({x:window.innerWidth/2, y:window.innerHeight/2, vx:(Math.random()-.5)*30, vy:(Math.random()-.5)*30, c:`hsl(${Math.random()*360},70%,50%)`}); updateConfetti(); }
    function updateConfetti() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        let act = false; parts.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=0.2; p.vx*=0.95; ctx.fillStyle=p.c; ctx.fillRect(p.x,p.y,8,8); if(p.y<canvas.height) act=true; });
        if(act) requestAnimationFrame(updateConfetti); else ctx.clearRect(0,0,canvas.width,canvas.height);
    }
  </script>
</body>
</html>